{"post_stream":{"posts":[{"id":17907,"name":"","username":"slapin","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png","created_at":"2017-05-17T23:58:23.241Z","cooked":"\u003cp\u003eLooking at the following Valgrind dump I see that my Node is gone inside AngelScript.\u003cbr\u003e\nIn my code I use \u003ccode\u003eSharedPtr\u0026lt;Node\u0026gt;\u003c/code\u003e to store that node in hope that it will keep reference, but it looks\u003cbr\u003e\nlike I don’t understand the concept:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e==18789== Invalid read of size 8\n==18789==    at 0x8B9AD2: Urho3D::UniquePtr\u0026lt;Urho3D::NodeImpl\u0026gt;::operator-\u0026gt;() const (Ptr.h:571)\n==18789==    by 0x8CCCA3: Urho3D::Node::GetName() const (Node.h:341)\n==18789==    by 0x8C9645: BTBlackboard::HandlePhysicsPreStep(Urho3D::StringHash, Urho3D::HashMap\u0026lt;Urho3D::StringHash, Urho3D::Variant\u0026gt;\u0026amp;) (BehaviorTree.cpp:83)\n==18789==    by 0x8CE123: Urho3D::EventHandlerImpl\u0026lt;BTBlackboard\u0026gt;::Invoke(Urho3D::HashMap\u0026lt;Urho3D::StringHash, Urho3D::Variant\u0026gt;\u0026amp;) (Object.h:307)\n==18789==    by 0xB731A3: Urho3D::Object::OnEvent(Urho3D::Object*, Urho3D::StringHash, Urho3D::HashMap\u0026lt;Urho3D::StringHash, Urho3D::Variant\u0026gt;\u0026amp;) (Object.cpp:113)\n==18789==    by 0xB73BE1: Urho3D::Object::SendEvent(Urho3D::StringHash, Urho3D::HashMap\u0026lt;Urho3D::StringHash, Urho3D::Variant\u0026gt;\u0026amp;) (Object.cpp:325)\n==18789==    by 0xC0A8EC: Urho3D::PhysicsWorld::PreStep(float) (PhysicsWorld.cpp:807)\n==18789==    by 0xC06355: Urho3D::InternalPreTickCallback(btDynamicsWorld*, float) (PhysicsWorld.cpp:71)\n==18789==    by 0xDB6510: btDiscreteDynamicsWorld::internalSingleStepSimulation(float) (btDiscreteDynamicsWorld.cpp:478)\n==18789==    by 0xDB647D: btDiscreteDynamicsWorld::stepSimulation(float, int, float) (btDiscreteDynamicsWorld.cpp:455)\n==18789==    by 0xC07A60: Urho3D::PhysicsWorld::Update(float) (PhysicsWorld.cpp:256)\n==18789==    by 0xC0A85A: Urho3D::PhysicsWorld::HandleSceneSubsystemUpdate(Urho3D::StringHash, Urho3D::HashMap\u0026lt;Urho3D::StringHash, Urho3D::Variant\u0026gt;\u0026amp;) (PhysicsWorld.cpp:796)\n==18789==  Address 0x1634cb58 is 312 bytes inside a block of size 352 free'd\n==18789==    at 0x4C2D360: operator delete(void*) (vg_replace_malloc.c:507)\n==18789==    by 0x96073C: Urho3D::Node::~Node() (Node.cpp:75)\n==18789==    by 0xB9AB6D: Urho3D::RefCounted::ReleaseRef() (RefCounted.cpp:65)\n==18789==    by 0xF0DACD: asCScriptEngine::CallObjectMethod(void*, asSSystemFunctionInterface*, asCScriptFunction*) const (as_scriptengine.cpp:4038)\n==18789==    by 0xF0D9AA: asCScriptEngine::CallObjectMethod(void*, int) const (as_scriptengine.cpp:4010)\n==18789==    by 0x8D9BF1: asCContext::ExecuteNext() (as_context.cpp:2771)\n==18789==    by 0x8D66BC: asCContext::Execute() (as_context.cpp:1297)\n==18789==    by 0x8BF99C: ScriptBehavior::update(BTBlackboard*) (ScriptBehavior.cpp:111)\n==18789==    by 0x8CAF72: BTBaseNode::Activate(BTBlackboard*) (BehaviorTree.cpp:167)\n==18789==    by 0x8CB05F: BTSequenceNode::update(BTBlackboard*) (BehaviorTree.cpp:188)\n==18789==    by 0x8CAF72: BTBaseNode::Activate(BTBlackboard*) (BehaviorTree.cpp:167)\n==18789==    by 0x8CB221: BTSelectorNode::update(BTBlackboard*) (BehaviorTree.cpp:242)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHow can I prevent of Node being free’d or could I at least get notified about this to prevent data corruption?\u003cbr\u003e\nOr is there some completely different way to handle such things?\u003c/p\u003e","post_number":1,"post_type":1,"updated_at":"2017-05-17T23:58:23.241Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":53,"reads":46,"readers_count":45,"score":274.2,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":554,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17911,"name":"Lasse Öörni","username":"cadaver","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png","created_at":"2017-05-18T07:27:49.969Z","cooked":"\u003cp\u003eSharedPtr is a strong ref, so it should keep the object alive. If your object dies even while a SharedPtr should still be pointing to it, I’d suspect your script binding doing too many Release()'s somewhere. AngelScript handles should be equivalent to SharedPtr in their behavior.\u003c/p\u003e\n\u003cp\u003eThe idiom used in Urho event handlers which expect potential self-destruction is to use a self-pointing WeakPtr and check whether that expires.\u003c/p\u003e","post_number":2,"post_type":1,"updated_at":"2017-05-18T07:28:24.376Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":39,"readers_count":38,"score":7.8,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"Lasse Öörni","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Urho3D Author","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":true,"staff":true,"user_id":3,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17925,"name":"Jonathan","username":"Sinoid","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/f19dbf/{size}.png","created_at":"2017-05-19T02:02:25.691Z","cooked":"\u003cp\u003eIf I’m reading that log correctly it looks like you constructed a UniquePtr with a RefCounted object through the “by pointer” constructor.\u003c/p\u003e\n\u003cp\u003eIf that’s the case - UniquePtr doesn’t care about anything else and will let you hang yourself (it’s for local stuff you own) - you probably want to be either keeping a WeakPtr that you’ll check before using or a solid SharedPtr.\u003c/p\u003e","post_number":3,"post_type":1,"updated_at":"2017-05-19T02:02:25.691Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":33,"readers_count":32,"score":6.6,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"Jonathan","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":669,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17937,"name":"","username":"slapin","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png","created_at":"2017-05-19T20:17:41.909Z","cooked":"\u003cp\u003eWell, the problem looks like I still need RefCounted for all objects if I want to use SharedPtr/WeakPtr.\u003c/p\u003e\n\u003cp\u003eNow I try to use WeakRef target; Then I select target node and set to “target” pointer.\u003cbr\u003e\nthen after some time I check the pointer and it looks fine. When I access it I get crash.\u003cbr\u003e\nValgrind shows the node was freed. So there is something fundamental which I don’t get.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eIf node is freed, then RefCounted values are freed too and might and will contain junk.\u003cbr\u003e\nIf I access WeakPtr after node was freed I can’t trust RefCounted values so I can’t know if it is safe to\u003cbr\u003e\naccess the pointer. So why bother? WeakPtr doesn’t have any useful purpose.\u003c/li\u003e\n\u003cli\u003eSame for SharedPtr - if the structure is freed, it is unsafe to use SharedPtr.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eSo all possible solution I see is to disable RefCounting completely.\u003c/p\u003e\n\u003cp\u003ePlease tell me I’m wrong and where I’m wrong.\u003cbr\u003e\nI’m debugging the crash for so long it hurts. With C it would take no longer than hour.\u003cbr\u003e\nMy hate to C++ is here again, I thought it is possible to do anything useful with C++ but i was wrong.\u003cbr\u003e\nI will probably drop all my class-based code and go for small C\u003cbr\u003e\nroutines for hot stuff, as I don’t see any progress.\u003c/p\u003e","post_number":4,"post_type":1,"updated_at":"2017-05-19T20:17:41.909Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":28,"readers_count":27,"score":10.6,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":554,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17939,"name":"Eugene Kozlov","username":"Eugene","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png","created_at":"2017-05-19T21:30:03.526Z","cooked":"\u003caside class=\"quote no-group\" data-username=\"slapin\" data-post=\"4\" data-topic=\"3130\"\u003e\n\u003cdiv class=\"title\"\u003e\n\u003cdiv class=\"quote-controls\"\u003e\u003c/div\u003e\n\u003cimg alt=\"\" width=\"20\" height=\"20\" src=\"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/40.png\" class=\"avatar\"\u003e slapin:\u003c/div\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIf I access WeakPtr after node was freed I can’t trust RefCounted values so I can’t know if it is safe to\u003cbr\u003e\naccess the pointer. So why bother? WeakPtr doesn’t have any useful purpose.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/aside\u003e\n\u003cp\u003eWeakPtr doesn’t get bad when object is destroyed, it is the only safe way to hold pointer that you don’t own.\u003cbr\u003e\nLooks like refcounting is broken somewhere.\u003cbr\u003e\nYou should probably share some code because refcounting itself doesn’t have such problems.\u003c/p\u003e","post_number":5,"post_type":1,"updated_at":"2017-05-19T21:30:03.526Z","reply_count":1,"reply_to_post_number":4,"quote_count":1,"incoming_link_count":0,"reads":27,"readers_count":26,"score":10.4,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"Eugene Kozlov","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Core developer","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":484,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17941,"name":"","username":"slapin","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png","created_at":"2017-05-19T23:00:05.386Z","cooked":"\u003cp\u003eIf the object was freed and overwritten, neither WeakPtr nor SharedPtr can be safely accessed.\u003c/p\u003e","post_number":6,"post_type":1,"updated_at":"2017-05-19T23:00:05.386Z","reply_count":1,"reply_to_post_number":5,"quote_count":0,"incoming_link_count":0,"reads":25,"readers_count":24,"score":10.0,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"reply_to_user":{"username":"Eugene","name":"Eugene Kozlov","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":554,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17943,"name":"Eugene Kozlov","username":"Eugene","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png","created_at":"2017-05-19T23:10:16.569Z","cooked":"\u003cp\u003eAccessed via arrow-op - no, it can’t. But WeakPtr remains valid. Null, but valid.\u003cbr\u003e\nIt is, actually, safe. You can’t get dangling pointers if use only SharedPtr and WeakPtr-s.\u003c/p\u003e","post_number":7,"post_type":1,"updated_at":"2017-05-19T23:10:47.305Z","reply_count":1,"reply_to_post_number":6,"quote_count":0,"incoming_link_count":0,"reads":23,"readers_count":22,"score":9.6,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"Eugene Kozlov","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Core developer","title_is_group":false,"reply_to_user":{"username":"slapin","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":484,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17948,"name":"","username":"slapin","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png","created_at":"2017-05-20T12:41:44.156Z","cooked":"\u003cp\u003eI wonder why I never get NULL WeakPtr if Node is freed and overwritten…\u003c/p\u003e","post_number":8,"post_type":1,"updated_at":"2017-05-20T12:41:44.156Z","reply_count":0,"reply_to_post_number":7,"quote_count":0,"incoming_link_count":0,"reads":23,"readers_count":22,"score":4.6,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"reply_to_user":{"username":"Eugene","name":"Eugene Kozlov","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":554,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17949,"name":"","username":"slapin","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png","created_at":"2017-05-20T15:00:01.968Z","cooked":"\u003cp\u003eI know I was right!\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eIf Node is deleted by ReleaseRef, SharedPtr/WeakPtr are not safe.\u003cbr\u003e\nThis can happen if we have more refs than we should. Like we get pointer from AS, process it and give back to AS, then the object gets destroyed, but the pointer is still in scene hierarchy, which leads to crashes and NULL pointer errors (later one is fine).\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe question is why this happens. If I AddRef pointer I got from AS, then I get one kind of crash (deletion by AS), if I don’t I get another crash (memory corruption). What is proper procedure for AS API binding to handle pointers\u003cbr\u003e\nreceived from AS? Any docs? The code works fine without AS involved but I need AS binding there.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e","post_number":9,"post_type":1,"updated_at":"2017-05-20T15:00:01.968Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":22,"readers_count":21,"score":9.4,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":554,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17955,"name":"","username":"slapin","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png","created_at":"2017-05-20T18:05:09.926Z","cooked":"\u003cp\u003eWell, It looks like I’m closer.\u003c/p\u003e\n\u003cp\u003eIn AS I do the following:\u003cbr\u003e\n\u003ccode\u003eArray\u0026lt;Node@\u0026gt;@ data = FindSomeNodes();\u003c/code\u003e\u003cbr\u003e\nwhere FindSomeNodes() is another AS function which looks for nodes complying to some criteria.\u003c/p\u003e\n\u003cp\u003eThen I parse this array and find one element, which I set to C++ code:\u003cbr\u003e\n\u003ccode\u003ebtb.target = data[closest_index];\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003ewhich leads to calling set_target() on my object, which just sets WeakRef target;\u003c/p\u003e\n\u003cp\u003eRunning this seems to drop reference count on node.\u003cbr\u003e\nAfter this I do \u003ccode\u003edata.Clear()\u003c/code\u003e in AS which leads to deletion of all array elements\u003cbr\u003e\nand runs ReleaseRef on all array elements. This particular node was assigned to WeakRef,\u003cbr\u003e\nand its refcount was decreased, which leads to node deletion.\u003c/p\u003e\n\u003cp\u003eNow I wonder how to prevent release of reference on on object in this situation?\u003cbr\u003e\nif btb was AS object, that would not happen, but btb is C++ object, and the magic happens.\u003cbr\u003e\nWhat can I do?\u003cbr\u003e\nI already worked this around by using node ID, but I wonder how to prevent this from happening?\u003cbr\u003e\nThanks!\u003c/p\u003e","post_number":10,"post_type":1,"updated_at":"2017-05-20T18:05:09.926Z","reply_count":1,"reply_to_post_number":9,"quote_count":0,"incoming_link_count":0,"reads":23,"readers_count":22,"score":9.6,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"reply_to_user":{"username":"slapin","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":554,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17958,"name":"Eugene Kozlov","username":"Eugene","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png","created_at":"2017-05-20T21:04:11.850Z","cooked":"\u003caside class=\"quote no-group\" data-username=\"slapin\" data-post=\"10\" data-topic=\"3130\"\u003e\n\u003cdiv class=\"title\"\u003e\n\u003cdiv class=\"quote-controls\"\u003e\u003c/div\u003e\n\u003cimg alt=\"\" width=\"20\" height=\"20\" src=\"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/40.png\" class=\"avatar\"\u003e slapin:\u003c/div\u003e\n\u003cblockquote\u003e\n\u003cp\u003eAfter this I do data.Clear() in AS which leads to deletion of all array elements\u003cbr\u003e\nand runs ReleaseRef on all array elements. This particular node was assigned to WeakRef,\u003cbr\u003e\nand its refcount was decreased, which leads to node deletion.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/aside\u003e\n\u003cp\u003eThat’s strange. Where does your node initially live?\u003cbr\u003e\nIf Scene owns these nodes, they can’t be destroyed by clearing some array.\u003c/p\u003e","post_number":11,"post_type":1,"updated_at":"2017-05-20T21:04:11.850Z","reply_count":1,"reply_to_post_number":10,"quote_count":1,"incoming_link_count":0,"reads":23,"readers_count":22,"score":9.6,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"Eugene Kozlov","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Core developer","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":484,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17996,"name":"","username":"slapin","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png","created_at":"2017-05-22T13:29:58.647Z","cooked":"\u003cp\u003eThey can, as reference count is reduced to 0.\u003c/p\u003e","post_number":12,"post_type":1,"updated_at":"2017-05-22T13:29:58.647Z","reply_count":1,"reply_to_post_number":11,"quote_count":0,"incoming_link_count":0,"reads":24,"readers_count":23,"score":9.8,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"reply_to_user":{"username":"Eugene","name":"Eugene Kozlov","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":554,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17998,"name":"Eugene Kozlov","username":"Eugene","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png","created_at":"2017-05-22T14:39:23.303Z","cooked":"\u003cp\u003eHow can ref counter get zero if Node is owned by the Scene?\u003c/p\u003e","post_number":13,"post_type":1,"updated_at":"2017-05-22T14:39:23.303Z","reply_count":1,"reply_to_post_number":12,"quote_count":0,"incoming_link_count":0,"reads":25,"readers_count":24,"score":10.0,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"Eugene Kozlov","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Core developer","title_is_group":false,"reply_to_user":{"username":"slapin","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":484,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17999,"name":"","username":"slapin","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png","created_at":"2017-05-22T14:56:37.537Z","cooked":"\u003cp\u003eEasily - something calls ReleaseRef on it.\u003cbr\u003e\nFor example this happens when prividing pointer to it to C++ property which is implemented as AS set/get.\u003cbr\u003e\nIf get doesn’t AddRef it, it will be ReleaseRef’ed twice, which will lead to freeing (ReleaseRef calls delete if refcount goes to 0). This way SharedPtr/WeakPtr will hold invalid reference.\u003cbr\u003e\nSo SharedPtr work bad as holders unless you do all operations through them.\u003cbr\u003e\nOr basically don’t forget to AddRef everything you give to AS, which will eleminate a problem (which is really hard to debug). But the rule about using WeakPtr/SharedPtr on freed object is unsafe still persists.\u003cbr\u003e\nIf you used object through WeakPtr and found it invalidated through that ptr, that is fine. Otherwise, don’t bother.\u003cbr\u003e\nThe same goes for SharedPtr - if you can’t control AddRef/ReleaseRef, you’re in trouble.\u003cbr\u003e\nIf you don’t use AS, you will be fine using SharedPtrs asn you will NEVER use AddRef/ReleaseRef directly\u003cbr\u003e\nunless you do something weird. But if you use AS (and probably Lua, not sure) - BEWARE.\u003c/p\u003e\n\u003cp\u003eHowever if you use only C++ you probably don’t need these pointer magic - just hold them in \u003ccode\u003eVector\u0026lt;SharedPtr\u0026lt;Foo\u0026gt;\u0026gt;\u003c/code\u003e and use raw pointers after this. But if you’re doing something complicated like object streaming (whatever that is) you might be interested in some object management. I think it is easier to hold everything “scenic” in scene, and components in nodes. Custom things might be static. Or kept these in vector. I’d recommend custom things which won’t change on the run and do not inherit RefCounted to keep in standard C++ management.\u003cbr\u003e\nThat will at least keep them out of scope of possible debugging nightmare.\u003c/p\u003e","post_number":14,"post_type":1,"updated_at":"2017-05-22T14:56:37.537Z","reply_count":1,"reply_to_post_number":13,"quote_count":0,"incoming_link_count":0,"reads":26,"readers_count":25,"score":10.2,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"reply_to_user":{"username":"Eugene","name":"Eugene Kozlov","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":554,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":18000,"name":"Eugene Kozlov","username":"Eugene","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png","created_at":"2017-05-22T16:00:05.826Z","cooked":"\u003caside class=\"quote no-group\" data-username=\"slapin\" data-post=\"14\" data-topic=\"3130\"\u003e\n\u003cdiv class=\"title\"\u003e\n\u003cdiv class=\"quote-controls\"\u003e\u003c/div\u003e\n\u003cimg alt=\"\" width=\"20\" height=\"20\" src=\"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/40.png\" class=\"avatar\"\u003e slapin:\u003c/div\u003e\n\u003cblockquote\u003e\n\u003cp\u003eEasily - something calls ReleaseRef on it.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/aside\u003e\n\u003cp\u003eBut it means that this \u003cem\u003esomething\u003c/em\u003e (e.g. script binding) is written badly!\u003cbr\u003e\nE.g. I’ve already found (and fixed) one problem in AS container with memory leaks caused by missing ReleaseRef.\u003c/p\u003e\n\u003cp\u003eIt is not the problem of SharedPtr, it is misusing of refcounter mechanism.\u003c/p\u003e\n\u003cp\u003eDo you have some small code? I’d like to debug it if there is a chance that Urho has broken bindings.\u003c/p\u003e\n\u003cp\u003eIf you write your own bindings, check counting there, especially \u003ccode\u003e@+\u003c/code\u003e and \u003ccode\u003e@\u003c/code\u003e.\u003c/p\u003e","post_number":15,"post_type":1,"updated_at":"2017-05-22T16:00:05.826Z","reply_count":0,"reply_to_post_number":14,"quote_count":1,"incoming_link_count":0,"reads":24,"readers_count":23,"score":4.8,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"Eugene Kozlov","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Core developer","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":484,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":18001,"name":"Lasse Öörni","username":"cadaver","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png","created_at":"2017-05-22T16:38:03.050Z","cooked":"\u003cp\u003eUrho’s inbuilt bindings use auto handles (@+) for the most part, that means no AddRef() / ReleaseRef() in bindings C++ code. In some cases bindings code first constructs an object into a SharedPtr, which will go out of scope; in this case we do manual AddRef() and don’t use auto handle for the return parameter.\u003c/p\u003e","post_number":16,"post_type":1,"updated_at":"2017-05-22T16:38:03.050Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":24,"readers_count":23,"score":9.8,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"Lasse Öörni","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Urho3D Author","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":true,"staff":true,"user_id":3,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":18002,"name":"","username":"slapin","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png","created_at":"2017-05-22T16:48:00.025Z","cooked":"\u003cp\u003eMy problem was that object was created in AS and handled to C++ get/set,\u003cbr\u003e\nwhich meant immediate destruction of object if not using AddRef. (I used Node).\u003cbr\u003e\nWeakPtr did not helped in this situation, but WeakPtr + AddRef did the trick.\u003c/p\u003e","post_number":17,"post_type":1,"updated_at":"2017-05-22T16:48:00.025Z","reply_count":0,"reply_to_post_number":16,"quote_count":0,"incoming_link_count":0,"reads":24,"readers_count":23,"score":4.8,"yours":false,"topic_id":3130,"topic_slug":"how-can-i-detect-that-sharedptr-is-gone","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"reply_to_user":{"username":"cadaver","name":"Lasse Öörni","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":554,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false}],"stream":[17907,17911,17925,17937,17939,17941,17943,17948,17949,17955,17958,17996,17998,17999,18000,18001,18002]},"timeline_lookup":[[1,2015],[3,2014],[4,2013],[10,2012],[12,2011]],"suggested_topics":[{"id":7160,"title":"RayCast trouble","fancy_title":"RayCast trouble","slug":"raycast-trouble","posts_count":17,"reply_count":9,"highest_post_number":19,"image_url":null,"created_at":"2022-01-29T00:06:00.367Z","last_posted_at":"2022-01-30T00:29:39.356Z","bumped":true,"bumped_at":"2022-01-30T00:29:39.356Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":3,"views":260,"category_id":10,"featured_link":null,"has_accepted_answer":true,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster, Accepted Answer","user":{"id":861,"username":"GodMan","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/g/e79b87/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":627,"username":"George1","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/g/9e8a1a/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":1038,"username":"dertom","name":"Thomas Trocha","avatar_template":"/user_avatar/discourse.urho3d.io/dertom/{size}/1815_2.png"}}]},{"id":7177,"title":"Attaching a shader to a BorderImage","fancy_title":"Attaching a shader to a BorderImage","slug":"attaching-a-shader-to-a-borderimage","posts_count":4,"reply_count":1,"highest_post_number":4,"image_url":null,"created_at":"2022-01-31T17:49:50.734Z","last_posted_at":"2022-02-01T02:22:10.927Z","bumped":true,"bumped_at":"2022-02-01T02:22:10.927Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":151,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":null,"description":"Original Poster","user":{"id":1165,"username":"throwawayerino","name":"Actually Permanent","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/t/da6949/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":484,"username":"Eugene","name":"Eugene Kozlov","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":631,"username":"JTippetts1","name":"J Tippetts","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts1/{size}/96_2.png"}}]},{"id":7186,"title":"Best way to do Blob Shadows in Urho","fancy_title":"Best way to do Blob Shadows in Urho","slug":"best-way-to-do-blob-shadows-in-urho","posts_count":3,"reply_count":1,"highest_post_number":3,"image_url":"https://global.discourse-cdn.com/standard17/uploads/urho3d/original/2X/2/22e3dc1892512375cae09bf84fd92071a1ae27d8.png","created_at":"2022-02-05T04:59:31.388Z","last_posted_at":"2022-02-05T13:29:22.054Z","bumped":true,"bumped_at":"2022-02-05T13:31:44.299Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":179,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":null,"description":"Original Poster","user":{"id":1334,"username":"najak3d","name":"Brian Knox","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/n/6a8cbe/{size}.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}}]},{"id":7176,"title":"Orthographic scene slowing down when zooming out","fancy_title":"Orthographic scene slowing down when zooming out","slug":"orthographic-scene-slowing-down-when-zooming-out","posts_count":1,"reply_count":0,"highest_post_number":1,"image_url":null,"created_at":"2022-01-30T10:05:50.218Z","last_posted_at":"2022-01-30T10:05:50.294Z","bumped":true,"bumped_at":"2022-01-30T10:05:50.294Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":127,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster","user":{"id":1351,"username":"Haukinger","name":"Haukinger","avatar_template":"/user_avatar/discourse.urho3d.io/haukinger/{size}/3670_2.png"}}]},{"id":7260,"title":"Is urho3d supported on Windows 8 and below?","fancy_title":"Is urho3d supported on Windows 8 and below?","slug":"is-urho3d-supported-on-windows-8-and-below","posts_count":2,"reply_count":0,"highest_post_number":2,"image_url":null,"created_at":"2022-05-11T12:24:39.422Z","last_posted_at":"2022-05-11T12:50:41.468Z","bumped":true,"bumped_at":"2022-05-11T12:50:41.468Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":5,"views":103,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":null,"description":"Original Poster","user":{"id":1519,"username":"Integar","name":"Torque189","avatar_template":"/user_avatar/discourse.urho3d.io/integar/{size}/3795_2.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":484,"username":"Eugene","name":"Eugene Kozlov","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png"}}]}],"tags_descriptions":{},"id":3130,"title":"How can I detect that SharedPtr is gone?","fancy_title":"How can I detect that SharedPtr is gone?","posts_count":17,"created_at":"2017-05-17T23:58:22.795Z","views":957,"reply_count":11,"like_count":0,"last_posted_at":"2017-05-22T16:48:00.025Z","visible":true,"closed":false,"archived":false,"has_summary":false,"archetype":"regular","slug":"how-can-i-detect-that-sharedptr-is-gone","category_id":10,"word_count":1748,"deleted_at":null,"user_id":554,"featured_link":null,"pinned_globally":false,"pinned_at":null,"pinned_until":null,"image_url":null,"slow_mode_seconds":0,"draft":null,"draft_key":"topic_3130","draft_sequence":null,"unpinned":null,"pinned":false,"current_post_number":1,"highest_post_number":17,"deleted_by":null,"actions_summary":[{"id":4,"count":0,"hidden":false,"can_act":false},{"id":8,"count":0,"hidden":false,"can_act":false},{"id":7,"count":0,"hidden":false,"can_act":false}],"chunk_size":20,"bookmarked":false,"bookmarks":[],"topic_timer":null,"message_bus_last_id":0,"participant_count":4,"show_read_indicator":false,"thumbnails":null,"slow_mode_enabled_until":null,"tags_disable_ads":false,"details":{"can_edit":false,"notification_level":1,"participants":[{"id":554,"username":"slapin","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png","post_count":9,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2},{"id":484,"username":"Eugene","name":"Eugene Kozlov","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png","post_count":5,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2},{"id":3,"username":"cadaver","name":"Lasse Öörni","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png","post_count":2,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"admin":true,"trust_level":2},{"id":669,"username":"Sinoid","name":"Jonathan","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/f19dbf/{size}.png","post_count":1,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2}],"created_by":{"id":554,"username":"slapin","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png"},"last_poster":{"id":554,"username":"slapin","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/dfb087/{size}.png"}}}