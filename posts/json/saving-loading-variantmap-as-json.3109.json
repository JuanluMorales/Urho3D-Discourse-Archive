{"post_stream":{"posts":[{"id":17728,"name":"","username":"JTippetts","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts/{size}/357_2.png","created_at":"2017-05-07T20:38:11.864Z","cooked":"\u003cp\u003eI’m trying to figure out how to save and load a standalone VariantMap as JSON.\u003c/p\u003e\n\u003cp\u003eCurrently, I implement the functions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003evoid SaveVariantMapJSON(String \u0026amp;fname, VariantMap \u0026amp;vm)\n{\n\tJSONFile jf(GetScriptContext());\n\tFile f(GetScriptContext());\n\tf.Open(fname, FILE_WRITE);\n\t\n\tJSONValue \u0026amp;root=jf.GetRoot();\n\troot.SetVariantMap(vm);\n\tjf.Save(f);\n}\n\nVariantMap LoadVariantMapJSON(String \u0026amp;fname)\n{\n\tJSONFile jf(GetScriptContext());\n\tFile f(GetScriptContext());\n\tf.Open(fname, FILE_READ);\n\t\n\tjf.BeginLoad(f);\n\tJSONValue \u0026amp;root=jf.GetRoot();\n\t\n\treturn root.GetVariantMap();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen I bind these functions to global functions in AngelScript. It seems to work on the face of it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003eVariantMap vm;\nvm[\"test\"]=\"test\";\nvm[\"testmap\"]=VariantMap();\nSaveVariantMapJSON(\"testvm.json\", vm);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis results in saving the json file:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003e{\n\t\"4745D132\": {\n\t\t\"type\": \"String\",\n\t\t\"value\": \"test\"\n\t},\n\t\"9949668A\": {\n\t\t\"type\": \"VariantMap\",\n\t\t\"value\": {}\n\t}\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, if I then try to load it in:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003eVariantMap nvm=LoadVariantMapJSON(\"testvm.json\");\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt doesn’t seem to work. It loads the file, it populates the VariantMap, and the values of the entries seem to be correct. I can iterate the values of the map and it shows two values, of type String and type Variant map, in the structure. However, the keys are not correct. Attempt to acess nvm[“test”] results in an empty Variant. Iterating the loaded variant map shows the following for key/valuetype:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003e00001289 : String\n0097D1E4 : VariantMap\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs you can see the hash keys are different from what was saved to the JSON file. It looks to me like it’s probably re-hashing the already hashed key or something to that effect.\u003c/p\u003e\n\u003cp\u003eIs there something I’m missing here? Is there a better way of doing this? I’m trying to store a sort of ad-hoc settings/configurations type of file which typically I would just save as a Lua table, but I’m trying to learn AngelScript which is requiring some different methods.\u003c/p\u003e\n\u003cp\u003eEdit: It seems like it might be a confusing of bases. In JSONValue::SetVariantMap, the VariantMap key is converted to a string via StringHash::ToString, which converts the hashed value to hexadecimal format. In JSONValue::GetVariantMap, the hash string is read and converted using GetUInt() using the default base (Base 10).\u003c/p\u003e\n\u003cp\u003eEdit2: Looks like that’s what is going on. By writing a helper function:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003eVariantMap GetVariantMap(JSONValue \u0026amp;v)\n{\n    VariantMap variantMap;\n    if (!v.IsObject())\n    {\n        URHO3D_LOGERROR(\"JSONValue is not a object\");\n        return variantMap;\n    }\n\n    for (ConstJSONObjectIterator i = v.Begin(); i != v.End(); ++i)\n    {\n        StringHash key(ToUInt(i-\u0026gt;first_, 16));\n        Variant variant = i-\u0026gt;second_.GetVariant();\n        variantMap[key] = variant;\n    }\n\n    return variantMap;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ewhich converts the hash string from base 16 instead, it works as expected. Of course, any nested maps will still use the built-in GetVariantMap function, so the full solution in this way would need to be writing external helpers for all the various GetVariant* functions.\u003c/p\u003e","post_number":1,"post_type":1,"updated_at":"2017-05-07T21:48:41.076Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":67,"reads":40,"readers_count":39,"score":343.0,"yours":false,"topic_id":3109,"topic_slug":"saving-loading-variantmap-as-json","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":5,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":30,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17736,"name":"Lasse Öörni","username":"cadaver","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png","created_at":"2017-05-08T07:50:03.498Z","cooked":"\u003cp\u003eShould be fixed in the engine to at least include your base16 fix. Ideally it should work with any keys in the JSON map, but that’s a hash reverse mapping problem.\u003c/p\u003e","post_number":2,"post_type":1,"updated_at":"2017-05-08T07:50:03.498Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":35,"readers_count":34,"score":7.0,"yours":false,"topic_id":3109,"topic_slug":"saving-loading-variantmap-as-json","display_username":"Lasse Öörni","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Urho3D Author","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":true,"staff":true,"user_id":3,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17739,"name":"Lasse Öörni","username":"cadaver","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png","created_at":"2017-05-08T10:34:18.941Z","cooked":"\u003cp\u003eBase16 fix is in master branch.\u003c/p\u003e","post_number":3,"post_type":1,"updated_at":"2017-05-08T10:34:18.941Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":33,"readers_count":32,"score":21.6,"yours":false,"topic_id":3109,"topic_slug":"saving-loading-variantmap-as-json","display_username":"Lasse Öörni","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Urho3D Author","title_is_group":false,"bookmarked":false,"actions_summary":[{"id":2,"count":1}],"moderator":false,"admin":true,"staff":true,"user_id":3,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false}],"stream":[17728,17736,17739]},"timeline_lookup":[[1,2025]],"suggested_topics":[{"id":7330,"title":"Is it Possible to Get New Bone Positions Directly After AnimationState.AddTime() Called?","fancy_title":"Is it Possible to Get New Bone Positions Directly After AnimationState.AddTime() Called?","slug":"is-it-possible-to-get-new-bone-positions-directly-after-animationstate-addtime-called","posts_count":2,"reply_count":0,"highest_post_number":2,"image_url":null,"created_at":"2022-09-22T11:18:00.223Z","last_posted_at":"2022-09-22T13:40:17.428Z","bumped":true,"bumped_at":"2022-09-22T13:40:17.428Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":81,"category_id":7,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster","user":{"id":1456,"username":"Jens","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/j/d2c977/{size}.png"}}]},{"id":7288,"title":"Samples not working!","fancy_title":"Samples not working!","slug":"samples-not-working","posts_count":11,"reply_count":5,"highest_post_number":11,"image_url":null,"created_at":"2022-06-26T08:30:04.842Z","last_posted_at":"2022-06-26T16:52:16.151Z","bumped":true,"bumped_at":"2022-06-26T16:52:16.151Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":148,"category_id":7,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":null,"description":"Original Poster","user":{"id":1528,"username":"cqrtxwd","name":"QR C","avatar_template":"/user_avatar/discourse.urho3d.io/cqrtxwd/{size}/3814_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":230,"username":"Nerrik","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/n/958977/{size}.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":263,"username":"1vanK","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/1vank/{size}/768_2.png"}}]},{"id":7132,"title":"How to Draw Anti-Aliased Outlined Line on the UI layer?","fancy_title":"How to Draw Anti-Aliased Outlined Line on the UI layer?","slug":"how-to-draw-anti-aliased-outlined-line-on-the-ui-layer","posts_count":8,"reply_count":5,"highest_post_number":8,"image_url":"https://global.discourse-cdn.com/standard17/uploads/urho3d/optimized/2X/c/c040fdbc2f1856c238ba6328fd7f5ff80b15858f_2_782x1024.jpeg","created_at":"2022-01-17T22:08:06.874Z","last_posted_at":"2022-01-20T20:13:30.614Z","bumped":true,"bumped_at":"2022-01-20T20:13:30.614Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":3,"views":173,"category_id":10,"featured_link":null,"has_accepted_answer":true,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":1334,"username":"najak3d","name":"Brian Knox","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/n/6a8cbe/{size}.png"}},{"extras":null,"description":"Frequent Poster, Accepted Answer","user":{"id":631,"username":"JTippetts1","name":"J Tippetts","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts1/{size}/96_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":192,"username":"Modanung","name":"魔大农 𝞍𝞎𝝳 現招蜍","avatar_template":"/user_avatar/discourse.urho3d.io/modanung/{size}/3290_2.png"}}]},{"id":7177,"title":"Attaching a shader to a BorderImage","fancy_title":"Attaching a shader to a BorderImage","slug":"attaching-a-shader-to-a-borderimage","posts_count":4,"reply_count":1,"highest_post_number":4,"image_url":null,"created_at":"2022-01-31T17:49:50.734Z","last_posted_at":"2022-02-01T02:22:10.927Z","bumped":true,"bumped_at":"2022-02-01T02:22:10.927Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":151,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":null,"description":"Original Poster","user":{"id":1165,"username":"throwawayerino","name":"Actually Permanent","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/t/da6949/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":484,"username":"Eugene","name":"Eugene Kozlov","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":631,"username":"JTippetts1","name":"J Tippetts","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts1/{size}/96_2.png"}}]},{"id":7156,"title":"Manual Mesh Part Animation (e.g. Rotate a propeller)","fancy_title":"Manual Mesh Part Animation (e.g. Rotate a propeller)","slug":"manual-mesh-part-animation-e-g-rotate-a-propeller","posts_count":4,"reply_count":1,"highest_post_number":4,"image_url":null,"created_at":"2022-01-26T23:50:29.343Z","last_posted_at":"2022-01-27T05:31:02.766Z","bumped":true,"bumped_at":"2022-01-27T05:31:02.766Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":4,"views":155,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":1334,"username":"najak3d","name":"Brian Knox","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/n/6a8cbe/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":631,"username":"JTippetts1","name":"J Tippetts","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts1/{size}/96_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":1038,"username":"dertom","name":"Thomas Trocha","avatar_template":"/user_avatar/discourse.urho3d.io/dertom/{size}/1815_2.png"}}]}],"tags_descriptions":{},"id":3109,"title":"Saving/Loading VariantMap as JSON","fancy_title":"Saving/Loading VariantMap as JSON","posts_count":3,"created_at":"2017-05-07T20:38:11.795Z","views":558,"reply_count":0,"like_count":1,"last_posted_at":"2017-05-08T10:34:18.941Z","visible":true,"closed":false,"archived":false,"has_summary":false,"archetype":"regular","slug":"saving-loading-variantmap-as-json","category_id":7,"word_count":490,"deleted_at":null,"user_id":30,"featured_link":null,"pinned_globally":false,"pinned_at":null,"pinned_until":null,"image_url":null,"slow_mode_seconds":0,"draft":null,"draft_key":"topic_3109","draft_sequence":null,"unpinned":null,"pinned":false,"current_post_number":1,"highest_post_number":3,"deleted_by":null,"actions_summary":[{"id":4,"count":0,"hidden":false,"can_act":false},{"id":8,"count":0,"hidden":false,"can_act":false},{"id":7,"count":0,"hidden":false,"can_act":false}],"chunk_size":20,"bookmarked":false,"bookmarks":[],"topic_timer":null,"message_bus_last_id":0,"participant_count":2,"show_read_indicator":false,"thumbnails":null,"slow_mode_enabled_until":null,"tags_disable_ads":false,"details":{"can_edit":false,"notification_level":1,"participants":[{"id":3,"username":"cadaver","name":"Lasse Öörni","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png","post_count":2,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"admin":true,"trust_level":2},{"id":30,"username":"JTippetts","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts/{size}/357_2.png","post_count":1,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2}],"created_by":{"id":30,"username":"JTippetts","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts/{size}/357_2.png"},"last_poster":{"id":3,"username":"cadaver","name":"Lasse Öörni","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png"}}}