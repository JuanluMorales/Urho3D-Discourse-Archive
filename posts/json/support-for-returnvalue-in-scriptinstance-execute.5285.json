{"post_stream":{"posts":[{"id":30650,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-07T05:49:32.950Z","cooked":"\u003cp\u003eToday I was prompted to make a minor change to the Urho3D sourcecode.\u003cbr\u003e\nGenerally speaking, I prefer to work around such issues, rather than mess with the engine source, however in this case I made an exception.\u003c/p\u003e\n\u003cp\u003eScriptFile::Execute supports an optional pointer to receive a return value when executing a script function or method.\u003cbr\u003e\nScriptInstance::Execute internally calls ScriptFile::Execute, but does not pass on, or provide for, the optional returnvalue container.\u003c/p\u003e\n\u003cp\u003eI made the following (harmless?) changes to ScriptInstance.h:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003e    /// Query for a method by declaration and execute. Log an error if not found.\n    bool Execute(const String\u0026amp; declaration, const VariantVector\u0026amp; parameters = Variant::emptyVariantVector, Variant* rv=nullptr);\n    /// Execute a method.\n    bool Execute(asIScriptFunction* method, const VariantVector\u0026amp; parameters = Variant::emptyVariantVector, Variant* rv=nullptr);\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd these changes to ScriptInstance.cpp:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003ebool ScriptInstance::Execute(const String\u0026amp; declaration, const VariantVector\u0026amp; parameters, Variant* rv)\n{\n    if (!scriptObject_)\n        return false;\n\n    asIScriptFunction* method = scriptFile_-\u0026gt;GetMethod(scriptObject_, declaration);\n    if (!method)\n    {\n        URHO3D_LOGERROR(\"Method \" + declaration + \" not found in class \" + className_);\n        return false;\n    }\n\n    return scriptFile_-\u0026gt;Execute(scriptObject_, method, parameters, rv);\n}\n\nbool ScriptInstance::Execute(asIScriptFunction* method, const VariantVector\u0026amp; parameters, Variant* rv)\n{\n    if (!method || !scriptObject_)\n        return false;\n\n    return scriptFile_-\u0026gt;Execute(scriptObject_, method, parameters, rv);\n}\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNoting that support for returnvalues was NOT extended to “delayed calls”, the C++ caller (such as my behavior tree nodes) can now receive return values when executing script methods.\u003cbr\u003e\nThis is the first and only change I’ve made in a fresh copy of the engine source I pulled down last week.\u003cbr\u003e\nIf anyone can think of a reason why this change is a bad idea, please let me know!\u003c/p\u003e","post_number":1,"post_type":1,"updated_at":"2019-07-07T05:50:27.253Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":7,"reads":42,"readers_count":41,"score":90.4,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[{"id":2,"count":2}],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30652,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-07T08:17:55.175Z","cooked":"\u003cp\u003eTo justify this change, I offer the following (rather convoluted) use-case.\u003cbr\u003e\nHere I have a situation where C++ will execute some AngelScript class method, and return something to the caller.\u003c/p\u003e\n\u003cp\u003eHere is the logic for a behavior tree node which can execute a named method of a scriptinstance, passing in zero, one or two variant arguments, and store a return argument, with storage context hints. Storage can be Global, Local (Caller Attribute/Property) or Local (Caller Node Variable)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003e    BTNodeState ServiceNode::HandleStep()  {\n\n            /// Method Arguments\n            VariantVector parameters;\n            /// Return Value\n            Variant rv;\n\n            /// Assume we have two arguments: if theres no first arg, then there will be no second arg!\n            bool checkArg2=true;\n\n            switch(Arg1Source_){\n                case RVT_AgentVariable:\n                    parameters.Push(tree_-\u0026gt;callingAgent-\u0026gt;GetNode()-\u0026gt;GetVar(Arg1Name_));\n                    break;\n                case RVT_AgentState:\n                    parameters.Push(tree_-\u0026gt;callingAgent-\u0026gt;GetAttribute(Arg1Name_));\n                    break;\n                case RVT_World:\n                      parameters.Push(GetGlobalVar(Arg1Name_));\n                    break;\n                case RVT_NONE:\n                    checkArg2=false;\n                    break;\n                default:\n                    URHO3D_LOGERROR(\"ServiceNode: Unhandled Arg1 Source\");\n            }\n\n            if(checkArg2){\n                switch(Arg2Source_){\n                    case RVT_AgentVariable:\n                        parameters.Push(tree_-\u0026gt;callingAgent-\u0026gt;GetNode()-\u0026gt;GetVar(Arg2Name_));\n                        break;\n                    case RVT_AgentState:\n                        parameters.Push(tree_-\u0026gt;callingAgent-\u0026gt;GetAttribute(Arg2Name_));\n                        break;\n                    case RVT_World:\n                          parameters.Push(GetGlobalVar(Arg2Name_));\n                        break;\n                    case RVT_NONE:\n                        break;\n                    default:\n                        URHO3D_LOGERROR(\"ServiceNode: Unhandled Arg2 Source\");\n                }\n            }\n\n            /// Execute script method, and note the return value from the script\n            bool result = tree_-\u0026gt;callingAgent-\u0026gt;Execute(decl_, parameters, \u0026amp;rv);\n\n            if(result)\n            {\n                state_=NS_SUCCESS;\n                \n                switch(RVTarget_){\n                    case RVT_AgentVariable:\n                        tree_-\u0026gt;callingAgent-\u0026gt;GetNode()-\u0026gt;SetVar(RVName_,rv);\n                    case RVT_AgentState:\n                        tree_-\u0026gt;callingAgent-\u0026gt;SetAttribute(RVName_,rv);\n                        break;\n                    case RVT_World:\n                        context_-\u0026gt;SetGlobalVar(RVName_, rv);\n                        break;\n                    case RVT_NONE:\n                        break;\n                    default:\n                        URHO3D_LOGERROR(\"Unhandled RVType in ServiceNode\");\n                }\n            }else{\n                URHO3D_LOGERROR(\"Failed to execute method with decl=\"+decl_);\n                state=NS_ERROR;\n            }\n\n            return state_;\n\n        }\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYes, this example is incomplete logically, I just got RV from AS, so its early days with this route to getting work done.\u003cbr\u003e\nI just wanted to show that yes, I actually do have a use-case that wants to know the return value, not just the result, of attempting script execution.\u003c/p\u003e","post_number":2,"post_type":1,"updated_at":"2019-07-07T08:41:52.539Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":38,"readers_count":37,"score":7.6,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":2,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30677,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-09T08:59:44.051Z","cooked":"\u003cp\u003eThere was one further change I needed to make (to ScriptFile.cpp) in order to receive returnvalues from script methods back to c++ caller…\u003cbr\u003e\nBasically I needed to copy some existing sourcecode from the “function execute” to the “method execute”, in order to get my return values handed back from script methods…\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003ebool ScriptFile::Execute(asIScriptObject* object, asIScriptFunction* method, const VariantVector\u0026amp; parameters, Variant* functionReturn,\n    bool unprepare)\n{\n    URHO3D_PROFILE(ExecuteMethod);\n\n    if (!compiled_ || !object || !method)\n        return false;\n\n    // It is possible that executing the method causes us to unload. Therefore do not rely on member variables\n    // However, we are not prepared for the whole script system getting destroyed during execution (should never happen)\n    Script* scriptSystem = script_;\n\n    asIScriptContext* context = scriptSystem-\u0026gt;GetScriptFileContext();\n    if (context-\u0026gt;Prepare(method) \u0026lt; 0)\n        return false;\n\n    context-\u0026gt;SetObject(object);\n    SetParameters(context, method, parameters);\n\n    scriptSystem-\u0026gt;IncScriptNestingLevel();\n    bool success = context-\u0026gt;Execute() \u0026gt;= 0;\n\n    if (success \u0026amp;\u0026amp; (functionReturn != nullptr))\n    {\n        const int typeId = method-\u0026gt;GetReturnTypeId();\n\n        asIScriptEngine* engine = script_-\u0026gt;GetScriptEngine();\n        asITypeInfo* typeInfo = engine-\u0026gt;GetTypeInfoById(typeId);\n\n        // Built-in type\n        if (typeInfo == nullptr)\n        {\n            switch (typeId)\n            {\n            case asTYPEID_VOID:\n                *functionReturn = Variant::EMPTY;\n                break;\n\n            case asTYPEID_BOOL:\n                *functionReturn = Variant(context-\u0026gt;GetReturnByte() \u0026gt; 0);\n                break;\n\n            case asTYPEID_INT8:\n            case asTYPEID_UINT8:\n            case asTYPEID_INT16:\n            case asTYPEID_UINT16:\n            case asTYPEID_INT32:\n            case asTYPEID_UINT32:\n                *functionReturn = Variant(static_cast\u0026lt;int\u0026gt;(context-\u0026gt;GetReturnDWord()));\n                break;\n\n            case asTYPEID_INT64:\n            case asTYPEID_UINT64:\n                *functionReturn = Variant(static_cast\u0026lt;long long\u0026gt;(context-\u0026gt;GetReturnQWord()));\n                break;\n\n            case asTYPEID_FLOAT:\n                *functionReturn = Variant(context-\u0026gt;GetReturnFloat());\n                break;\n\n            case asTYPEID_DOUBLE:\n                *functionReturn = Variant(context-\u0026gt;GetReturnDouble());\n                break;\n            }\n        }\n        else if (typeInfo-\u0026gt;GetFlags() \u0026amp; asOBJ_REF)\n        {\n            *functionReturn = Variant(static_cast\u0026lt;RefCounted*\u0026gt;(context-\u0026gt;GetReturnObject()));\n        }\n        else if (typeInfo-\u0026gt;GetFlags() \u0026amp; asOBJ_VALUE)\n        {\n            void* returnedObject = context-\u0026gt;GetReturnObject();\n\n            const VariantType variantType = Variant::GetTypeFromName(typeInfo-\u0026gt;GetName());\n            switch (variantType)\n            {\n            case VAR_STRING:\n                *functionReturn = *static_cast\u0026lt;String*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_VECTOR2:\n                *functionReturn = *static_cast\u0026lt;Vector2*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_VECTOR3:\n                *functionReturn = *static_cast\u0026lt;Vector3*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_VECTOR4:\n                *functionReturn = *static_cast\u0026lt;Vector4*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_QUATERNION:\n                *functionReturn = *static_cast\u0026lt;Quaternion*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_COLOR:\n                *functionReturn = *static_cast\u0026lt;Color*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_INTRECT:\n                *functionReturn = *static_cast\u0026lt;IntRect*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_INTVECTOR2:\n                *functionReturn = *static_cast\u0026lt;IntVector2*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_MATRIX3:\n                *functionReturn = *static_cast\u0026lt;Matrix3*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_MATRIX3X4:\n                *functionReturn = *static_cast\u0026lt;Matrix3x4*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_MATRIX4:\n                *functionReturn = *static_cast\u0026lt;Matrix4*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_RECT:\n                *functionReturn = *static_cast\u0026lt;Rect*\u0026gt;(returnedObject);\n                break;\n\n            case VAR_INTVECTOR3:\n                *functionReturn = *static_cast\u0026lt;IntVector3*\u0026gt;(returnedObject);\n                break;\n\n            default:\n                URHO3D_LOGERRORF(\"Return type (%c) is not supported\", typeInfo-\u0026gt;GetName());\n                break;\n            }\n        }\n        else\n        {\n            URHO3D_LOGERRORF(\"Return type (%c)is not supported\", typeInfo-\u0026gt;GetName());\n        }\n    }\n\n    if (unprepare)\n        context-\u0026gt;Unprepare();\n    scriptSystem-\u0026gt;DecScriptNestingLevel();\n\n    return success;\n}\u003c/code\u003e\u003c/pre\u003e","post_number":3,"post_type":1,"updated_at":"2019-07-09T13:30:35.423Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":36,"readers_count":35,"score":22.2,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":2,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[{"id":2,"count":1}],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30686,"name":"SirNate0","username":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png","created_at":"2019-07-09T16:27:27.067Z","cooked":"\u003cp\u003eProvided you’ve tested this with, e.g. all of passing built-in types and pod types like Vector3 and pointer tires (like a Node*/Node@), I am fully in favor of this code bring moved into master. (I’d actually support it even if you broke the existing API, as I think this is functionality that the engine has been lacking for years).\u003c/p\u003e\n\u003cp\u003eI remember I tried to do something similar before where I basically ended up having to pass “return” values by reference into the script function and then modify them in that, but it would fail for built in types like integers (so they’d have to be passed in an IntVector2 or something). This approach seems to cleanly solve the problem (unlike my hacked together approach), so I’m for it! Thanks for solving the problem well!\u003c/p\u003e\n\u003cp\u003eRegarding delayed calls, it seems to me that with the work done to handle return values already completed, it would be plausible to allow an optional \u003ccode\u003estd::function\u0026lt;void, Variant\u0026gt;\u003c/code\u003e to be called on the return value, or we could put the return value in the event that I assume we send when the delayed execute is finished. (I don’t think the rest of the code needs to wait for this possible improvement to be merged, though)\u003c/p\u003e","post_number":4,"post_type":1,"updated_at":"2019-07-09T16:27:27.067Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":32,"readers_count":31,"score":41.4,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"SirNate0","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[{"id":2,"count":2}],"moderator":false,"admin":false,"staff":false,"user_id":628,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30691,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-10T06:11:48.495Z","cooked":"\u003cp\u003eI’m currently experimenting with returning various datatypes - so far the only noticeable problem is unpacking array types, which I think I can probably sort out. At any rate, any return types that are a problem for method execution, will also be a problem for function execution, since I basically copied and pasted the code to unpack return value types…\u003cbr\u003e\n[EDIT]\u003cbr\u003e\nAn unexpected problem return type was Variant.\u003cbr\u003e\nThe code (as posted) to wrap return values does not expect that scripts might actually be nice and return a variant already wrapped…\u003cbr\u003e\nI’ll repost my code to include any further type support once I’ve had a chance to test more thoroughly.\u003c/p\u003e\n\u003cp\u003eNotice that I have to wrap angelscript strings in Urho String before trying to compare them… compare will fail if I don’t do that, guess String is missing some compare cases…\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003e\t    if(String(typeInfo-\u0026gt;GetName())==\"Variant\")\n\t    {\n                    *functionReturn=*static_cast\u0026lt;Variant*\u0026gt;(returnedObject);\n\n\t    }else{\n\t\t    const VariantType variantType = Variant::GetTypeFromName(typeInfo-\u0026gt;GetName());\n\t\t    switch (variantType)\n\t\t    {\n\t\t    case VAR_STRING:\u003c/code\u003e\u003c/pre\u003e","post_number":5,"post_type":1,"updated_at":"2019-07-10T07:10:46.133Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":31,"readers_count":30,"score":6.2,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":3,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30696,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-10T08:27:42.418Z","cooked":"\u003cp\u003eThere are a few bumps ahead, as the existing code I borrowed is far from type-complete, but if a Variant can hold it, then I assume I can resolve the issues. The key thing to remember is that the return value will be held by a variant - so it has to be acceptable in terms of what a variant can hold.\u003c/p\u003e","post_number":6,"post_type":1,"updated_at":"2019-07-10T08:28:59.018Z","reply_count":0,"reply_to_post_number":4,"quote_count":0,"incoming_link_count":0,"reads":29,"readers_count":28,"score":35.8,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"reply_to_user":{"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"},"bookmarked":false,"actions_summary":[{"id":2,"count":2}],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30713,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-11T09:28:16.526Z","cooked":"\u003cp\u003eOne major stumbling block appears to be CScriptArray!\u003cbr\u003e\nIf this is a reference type, why is it implementing its own refcount? Why does it not derive from RefCounted?\u003cbr\u003e\nIf this is a template container type, but holds a void*, why is no solid type information retained within the class?\u003cbr\u003e\n[EDIT]\u003cbr\u003e\nWhen instantiated by AngelScript, the CScriptArray object does contain angelscript type information for the element type, including a name string. Further, we can query Variant for a corresponding Urho type by name. So it’s not all bad.\u003c/p\u003e","post_number":7,"post_type":1,"updated_at":"2019-07-12T05:47:31.536Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":31,"readers_count":30,"score":11.2,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":2,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30723,"name":"SirNate0","username":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png","created_at":"2019-07-11T12:08:48.090Z","cooked":"\u003cp\u003eIf I had to guess, some of the shortcomings might be because it was adapted from the AngelScript add-on code. In terms of type information, is the \u003ccode\u003easITypeInfo* objType\u003c/code\u003e insufficient?\u003c/p\u003e","post_number":8,"post_type":1,"updated_at":"2019-07-11T12:08:48.090Z","reply_count":0,"reply_to_post_number":7,"quote_count":0,"incoming_link_count":0,"reads":31,"readers_count":30,"score":21.2,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"SirNate0","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"reply_to_user":{"username":"Leith","name":"Leith Ketchell","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png"},"bookmarked":false,"actions_summary":[{"id":2,"count":1}],"moderator":false,"admin":false,"staff":false,"user_id":628,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30727,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-12T04:45:30.599Z","cooked":"\u003cp\u003eHere’s what I’ve come up with so far… It’s not the most pretty code I’ve ever written, but it should handle all kinds of return types… primitives, variants, object refs, and arrays of these things (but not nested arrays…)\u003cbr\u003e\nNote that arrays are always returned as a VariantVector: CScriptArray can always be “unpacked” into a variant vector, although Urho appears not to provide a utility function that can do it.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003e   /// Execute an object method.\n    bool Execute(asIScriptObject* object, asIScriptFunction* method, const VariantVector\u0026amp; parameters = Variant::emptyVariantVector,\n        Variant* functionReturn = nullptr, bool unprepare = true)\n{\n//    URHO3D_PROFILE(ExecuteMethod);\n\n    if (!compiled_ || !object || !method)\n        return false;\n\n    // It is possible that executing the method causes us to unload. Therefore do not rely on member variables\n    // However, we are not prepared for the whole script system getting destroyed during execution (should never happen)\n    Script* scriptSystem = script_;\n\n    asIScriptContext* context = scriptSystem-\u0026gt;GetScriptFileContext();\n    if (context-\u0026gt;Prepare(method) \u0026lt; 0)\n        return false;\n\n    context-\u0026gt;SetObject(object);\n    SetParameters(context, method, parameters);\n\n    scriptSystem-\u0026gt;IncScriptNestingLevel();\n    bool success = context-\u0026gt;Execute() \u0026gt;= 0;\n\n    if (success \u0026amp;\u0026amp; (functionReturn != nullptr))\n    {\n        const int typeId = method-\u0026gt;GetReturnTypeId();\n\n        asIScriptEngine* engine = script_-\u0026gt;GetScriptEngine();\n        asITypeInfo* typeInfo = engine-\u0026gt;GetTypeInfoById(typeId);\n\n        // Built-in type\n        if (typeInfo == nullptr)\n        {\n            switch (typeId)\n            {\n            case asTYPEID_VOID:\n                *functionReturn = Variant::EMPTY;\n                break;\n\n            case asTYPEID_BOOL:\n                *functionReturn = Variant(context-\u0026gt;GetReturnByte() \u0026gt; 0);\n                break;\n\n            case asTYPEID_INT8:\n            case asTYPEID_UINT8:\n            case asTYPEID_INT16:\n            case asTYPEID_UINT16:\n            case asTYPEID_INT32:\n            case asTYPEID_UINT32:\n                *functionReturn = Variant(static_cast\u0026lt;int\u0026gt;(context-\u0026gt;GetReturnDWord()));\n                break;\n\n            case asTYPEID_INT64:\n            case asTYPEID_UINT64:\n                *functionReturn = Variant(static_cast\u0026lt;long long\u0026gt;(context-\u0026gt;GetReturnQWord()));\n                break;\n\n            case asTYPEID_FLOAT:\n                *functionReturn = Variant(context-\u0026gt;GetReturnFloat());\n                break;\n\n            case asTYPEID_DOUBLE:\n                *functionReturn = Variant(context-\u0026gt;GetReturnDouble());\n                break;\n            }\n        }\n        else if (typeInfo-\u0026gt;GetFlags() \u0026amp; asOBJ_REF)\n        {\n            /// Check for special case: array type\n            String name=typeInfo-\u0026gt;GetName();\n            if(name==\"Array\")\n            {\n                /// We have an array\u0026lt;T\u0026gt; on our hands...\n                CScriptArray* ary = static_cast\u0026lt;CScriptArray*\u0026gt;(context-\u0026gt;GetReturnObject());\n                int cnt=ary-\u0026gt;GetSize();\n                VariantVector vary(cnt);\n\n\n                /// Query the type of array elements (ie type of T)\n                String subname=typeInfo-\u0026gt;GetSubType(0)-\u0026gt;GetName();\n                int flags=typeInfo-\u0026gt;GetSubType(0)-\u0026gt;GetFlags();\n\n\n                /// Check if we have an array of \"handles\"\n                /// If so, we will assume that all handles are pointers to Urho3D Objects\n                /// which always derive from \"RefCounted\"...\n                if(flags\u0026amp;asOBJ_REF)\n                {\n                    for(int i=0;i\u0026lt;cnt;i++)\n                        vary[i]=static_cast\u0026lt;RefCounted*\u0026gt;(ary-\u0026gt;At(i));\n                    *functionReturn = Variant(vary);\n\n                /// Check if we have an array of \"values\"\n                }else if(flags\u0026amp;asOBJ_VALUE){\n\n                    /// Check for special case: value is already a Variant\n                    if(subname==\"Variant\")\n                    {\n                        for(int i=0;i\u0026lt;cnt;i++)\n                            vary[i]=*static_cast\u0026lt;Variant*\u0026gt;(ary-\u0026gt;At(i));\n                        *functionReturn = Variant(vary);\n\n\n                    }else{\n                        /// Handle all variant-supported types\n                        const VariantType variantType = Variant::GetTypeFromName(subname);\n                        switch (variantType)\n                        {\n                        case VAR_BOOL:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;Bool*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_FLOAT:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;float*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_DOUBLE:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;double*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_INT:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;int*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_INT64:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;int64_t*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_STRING:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;String*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_VECTOR2:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;Vector2*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_VECTOR3:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;Vector3*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_VECTOR4:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;Vector4*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_QUATERNION:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;Quaternion*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_COLOR:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;Color*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_INTRECT:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;IntRect*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_INTVECTOR2:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;IntVector2*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_MATRIX3:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;Matrix3*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_MATRIX3X4:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;Matrix3x4*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_MATRIX4:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;Matrix4*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_RECT:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;Rect*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_INTVECTOR3:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;IntVector3*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        case VAR_VARIANTVECTOR:\n                            for(int i=0;i\u0026lt;cnt;i++)\n                                vary[i]=*static_cast\u0026lt;VariantVector*\u0026gt;(ary-\u0026gt;At(i));\n                            *functionReturn = Variant(vary);\n                            break;\n\n                        default:\n                            URHO3D_LOGERROR(\"Array value type is not supported by Variant: typeid is \" +String(typeId)+\" VarType=\"+String((int)variantType)+\" \"+ subname);\n                        }\n                    }\n\n                }else{\n                    URHO3D_LOGERROR(\"Unhandled type detected in Array: \"+subname);\n                    *functionReturn = Variant::EMPTY;\n                }\n\n            }\n            else{\n                /// We can generally assume that Handles are pointers to Urho3D Objects\n                /// which always derive from \"RefCounted\"...\n                RefCounted* obj = static_cast\u0026lt;RefCounted*\u0026gt;(context-\u0026gt;GetReturnObject());\n                *functionReturn = Variant(obj);\n            }\n        }\n\n        else if (typeInfo-\u0026gt;GetFlags() \u0026amp; asOBJ_VALUE)\n        {\n            void* returnedObject = context-\u0026gt;GetReturnObject();\n\n            if(String(typeInfo-\u0026gt;GetName())==\"Variant\")\n            {\n                        *functionReturn=*static_cast\u0026lt;Variant*\u0026gt;(returnedObject);\n\n            }else{\n                const VariantType variantType = Variant::GetTypeFromName(typeInfo-\u0026gt;GetName());\n                switch (variantType)\n                {\n                case VAR_STRING:\n                    *functionReturn = *static_cast\u0026lt;String*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_VECTOR2:\n                    *functionReturn = *static_cast\u0026lt;Vector2*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_VECTOR3:\n                    *functionReturn = *static_cast\u0026lt;Vector3*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_VECTOR4:\n                    *functionReturn = *static_cast\u0026lt;Vector4*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_QUATERNION:\n                    *functionReturn = *static_cast\u0026lt;Quaternion*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_COLOR:\n                    *functionReturn = *static_cast\u0026lt;Color*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_INTRECT:\n                    *functionReturn = *static_cast\u0026lt;IntRect*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_INTVECTOR2:\n                    *functionReturn = *static_cast\u0026lt;IntVector2*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_MATRIX3:\n                    *functionReturn = *static_cast\u0026lt;Matrix3*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_MATRIX3X4:\n                    *functionReturn = *static_cast\u0026lt;Matrix3x4*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_MATRIX4:\n                    *functionReturn = *static_cast\u0026lt;Matrix4*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_RECT:\n                    *functionReturn = *static_cast\u0026lt;Rect*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_INTVECTOR3:\n                    *functionReturn = *static_cast\u0026lt;IntVector3*\u0026gt;(returnedObject);\n                    break;\n\n                case VAR_VARIANTVECTOR:\n                *functionReturn = *static_cast\u0026lt;VariantVector*\u0026gt;(returnedObject);\n                break;\n\n                default:\n                    URHO3D_LOGERROR(\"Return value type is not supported: typeid is \" +String(typeId)+\" VarType=\"+String((int)variantType)+\" \"+ typeInfo-\u0026gt;GetName());\n                    break;\n                }\n            }\n        }\n        else\n        {\n            URHO3D_LOGERRORF(\"Return type (%c)is not supported\",typeInfo-\u0026gt;GetName());\n        }\n    }\n\n    if (unprepare)\n        context-\u0026gt;Unprepare();\n    scriptSystem-\u0026gt;DecScriptNestingLevel();\n\n    return success;\n}\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNote that I moved this method temporarily from ScriptFile.cpp to ScriptFile.h just because it’s easier for me to debug engine code when it’s not part of the static library.\u003c/p\u003e","post_number":9,"post_type":1,"updated_at":"2019-07-12T05:33:06.594Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":33,"readers_count":32,"score":21.6,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":2,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[{"id":2,"count":1}],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30731,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-12T07:51:17.311Z","cooked":"\u003cp\u003eThat code contains some 2 or 3 small typo bugs, but otherwise compiles fine.\u003c/p\u003e","post_number":10,"post_type":1,"updated_at":"2019-07-12T07:51:17.311Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":25,"readers_count":24,"score":5.0,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30743,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-13T10:34:12.568Z","cooked":"\u003cp\u003eI am still currently not understanding why our CScriptArray implementation has its own addref and release methods, instead of deriving from RefCounted.\u003c/p\u003e\n\u003cp\u003eIf the object was refcounted, I could reduce the amount of code in my version of ScriptFile::Execute by half… I would not have to deal with a special case class which angelscript says is REF but urho says is not derived from RefCounted, like every other non-value class registered with angelscript.\u003c/p\u003e\n\u003cp\u003eI recognize the sourcecode from the angelscript website, I appreciate that its legacy code, but why is it \u003cem\u003estill\u003c/em\u003e legacy code at this time?\u003c/p\u003e","post_number":11,"post_type":1,"updated_at":"2019-07-13T10:44:58.323Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":25,"readers_count":24,"score":5.0,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":2,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30745,"name":"SirNate0","username":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png","created_at":"2019-07-13T20:38:43.606Z","cooked":"\u003cp\u003eLooking through the source, I think the reason we didn’t just replace the reference counting comes down to how the existing code handles the memory management. It seems AS uses malloc and free, while RefCounted uses delete. I’m certainly not against the implementation being updated, but I imagine no one else has felt a need to do it since prior to this it probably didn’t require any extra work. Another difference seems to be that RefCounted allows weak references, which I don’t think the AngelScript types have any notion of.\u003c/p\u003e\n\u003cp\u003eIt’s probably pretty straightforward to correct this, since there seem to be only about a dozen uses of the userAlloc and userFree functions between the dictionary and the array. The only concern I’d raise is that this may require more work in updating the AngelScript library later on, since presently I think our changes are limited to disabling garbage collection.\u003c/p\u003e","post_number":12,"post_type":1,"updated_at":"2019-07-13T20:38:43.606Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":25,"readers_count":24,"score":10.0,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"SirNate0","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":628,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30747,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-14T03:43:30.686Z","cooked":"\u003cp\u003eApparently we already have support for weakptr handles:\u003c/p\u003e\n\u003caside class=\"quote no-group\"\u003e\n\u003cblockquote\u003e\n\u003cp\u003eWeakHandle rigidBodyWeak = node.CreateComponent(“RigidBody”);\u003cbr\u003e\nRigidBody@ rigidBodyShared = rigidBodyWeak.Get(); // Is null if expired\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/aside\u003e\n\u003cp\u003eThere is also some example addon sourcecode for angelscript weakptr which I might look into, but for the moment I have a much more simple problem…\u003c/p\u003e\n\u003caside class=\"quote no-group\"\u003e\n\u003cblockquote\u003e\n\u003cp\u003eAdditional global properties exist for accessing the script object’s node, the scene and the scene-wide components: node, scene, octree, physicsWorld, debugRenderer. When an object method is not executing, these are null. \"\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/aside\u003e\n\u003cp\u003eMy script class (Actor.Update method in my test script) calls a c++ global function which in turn leads to a nested execution of a script method on the same class… that is to say, when Urho engine calls the script update method, execution is passed from script to my c++ function, and then from c++ I call another script method on the same instance of the same script class… we’re now two angelscript contexts deep (since our implementation creates a new script context per nesting depth)…\u003c/p\u003e\n\u003cp\u003eWhen executing script in this nested fashion, the script global properties mentioned above are null - where exactly are these “properties” being set and cleared?\u003c/p\u003e","post_number":13,"post_type":1,"updated_at":"2019-07-14T04:19:12.030Z","reply_count":1,"reply_to_post_number":12,"quote_count":0,"incoming_link_count":0,"reads":27,"readers_count":26,"score":10.4,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":3,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"reply_to_user":{"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30754,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-15T12:50:24.615Z","cooked":"\u003cp\u003eOn this topic, why the hell are we making a new context per depth, when we have push and pop methods on the context, wholly intended to deal with nesting?\u003c/p\u003e","post_number":14,"post_type":1,"updated_at":"2019-07-15T12:50:24.615Z","reply_count":1,"reply_to_post_number":13,"quote_count":0,"incoming_link_count":0,"reads":28,"readers_count":27,"score":10.6,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"reply_to_user":{"username":"Leith","name":"Leith Ketchell","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30755,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-15T12:53:28.685Z","cooked":"\u003cp\u003eif our angelscript implementation is the coal face of this engine, then we need to evaluate our implementation, the addons, all of it - in its current state, I find it unusable. I have use cases you can test.\u003c/p\u003e","post_number":15,"post_type":1,"updated_at":"2019-07-16T10:20:07.464Z","reply_count":0,"reply_to_post_number":14,"quote_count":0,"incoming_link_count":0,"reads":28,"readers_count":27,"score":5.6,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":2,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"reply_to_user":{"username":"Leith","name":"Leith Ketchell","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":31755,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-08-01T09:33:45.353Z","cooked":"\u003cp\u003eHere is a proposed patch to allow AngelScript to return rubber values to C++ callers - changes appear not to break existing code … both functions and script class methods are supported - return values are anything we can shove into a variant, including arrays, and possibly, arrays of arrays, of any variant-containable value type.\u003cbr\u003e\n\u003ca href=\"https://www.dropbox.com/s/d48oorgsgz6okoz/AngelScript_FullRV.zip?dl=0\" rel=\"nofollow noopener\"\u003ehttps://www.dropbox.com/s/d48oorgsgz6okoz/AngelScript_FullRV.zip?dl=0\u003c/a\u003e\u003c/p\u003e","post_number":16,"post_type":1,"updated_at":"2019-08-01T09:36:51.926Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":25,"readers_count":24,"score":35.0,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"https://www.dropbox.com/s/d48oorgsgz6okoz/AngelScript_FullRV.zip?dl=0","internal":false,"reflection":false,"title":"Dropbox - AngelScript_FullRV.zip - Simplify your life","clicks":5}],"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[{"id":2,"count":2}],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":true},{"id":31757,"name":"","username":"George1","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/g/9e8a1a/{size}.png","created_at":"2019-08-01T09:45:52.812Z","cooked":"\u003cp\u003ewhile you are at this.  Maybe help to look at reloading of script or re assignment to new script.  This way it is possible to change the behaviour of agent/component in realtime.  Great for testing of new behaviour and features.\u003c/p\u003e","post_number":17,"post_type":1,"updated_at":"2019-08-01T09:46:25.860Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":23,"readers_count":22,"score":39.6,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[{"id":2,"count":2}],"moderator":false,"admin":false,"staff":false,"user_id":627,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":31760,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-08-01T09:58:16.017Z","cooked":"\u003cp\u003eI don’t pretend to know everything - live updates, and monitoring files for changes, is not so far on my todo list, but I will consider adding that, because live editing is the main reason to use scripting - that we can make changes, even without closing our app… and see the changes, in realtime. Rapid application development is where it’s at. I will see what I can do, but I don’t really know what’s been done! I am not an expert in Urho - it’s a big topic, I am a fairly new user to Urho. I am not new to gamedev. I will look into it \u003cimg src=\"https://emoji.discourse-cdn.com/twitter/slight_smile.png?v=9\" title=\":slight_smile:\" class=\"emoji\" alt=\":slight_smile:\"\u003e\u003c/p\u003e","post_number":18,"post_type":1,"updated_at":"2019-08-01T09:58:16.017Z","reply_count":1,"reply_to_post_number":17,"quote_count":0,"incoming_link_count":0,"reads":24,"readers_count":23,"score":39.8,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"reply_to_user":{"username":"George1","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/g/9e8a1a/{size}.png"},"bookmarked":false,"actions_summary":[{"id":2,"count":2}],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":31834,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-08-01T13:28:54.947Z","cooked":"\u003cp\u003eThe reason I developed this patch was to support data-driven AI behavior trees, which need at some point to get connected to named code functions, which is something c++ is natively bad at doing - script functions / class methods offered a way to hook up c++ code to named scripted functions at runtime, but Urho’s existing implementation (with respect to Return Values) was incomplete - there was indication of a return value in the ScriptFile class, but it was only partially implemented for script functions, and not at all for script class methods. I filled in the gaps.\u003c/p\u003e","post_number":19,"post_type":1,"updated_at":"2019-08-02T06:43:58.474Z","reply_count":0,"reply_to_post_number":18,"quote_count":0,"incoming_link_count":0,"reads":22,"readers_count":21,"score":4.4,"yours":false,"topic_id":5285,"topic_slug":"support-for-returnvalue-in-scriptinstance-execute","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":3,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"reply_to_user":{"username":"Leith","name":"Leith Ketchell","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false}],"stream":[30650,30652,30677,30686,30691,30696,30713,30723,30727,30731,30743,30745,30747,30754,30755,31755,31757,31760,31834]},"timeline_lookup":[[1,1235],[3,1233],[5,1232],[7,1231],[9,1230],[11,1229],[12,1228],[14,1227],[16,1210]],"suggested_topics":[{"id":7304,"title":"Urho3D is crashing on Android 12","fancy_title":"Urho3D is crashing on Android 12","slug":"urho3d-is-crashing-on-android-12","posts_count":1,"reply_count":0,"highest_post_number":1,"image_url":null,"created_at":"2022-07-28T10:03:51.280Z","last_posted_at":"2022-07-28T10:03:51.349Z","bumped":true,"bumped_at":"2022-07-28T10:38:06.014Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":1,"views":126,"category_id":9,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster","user":{"id":809,"username":"elix22","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/elix22/{size}/1437_2.png"}}]},{"id":7344,"title":"Do we give up supporting dx11？","fancy_title":"Do we give up supporting dx11？","slug":"do-we-give-up-supporting-dx11","posts_count":3,"reply_count":1,"highest_post_number":3,"image_url":null,"created_at":"2022-11-03T09:37:37.893Z","last_posted_at":"2022-11-03T13:09:15.153Z","bumped":true,"bumped_at":"2022-11-03T15:28:58.128Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":78,"category_id":9,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":1510,"username":"SoNewBee","name":"So New Bee","avatar_template":"/user_avatar/discourse.urho3d.io/sonewbee/{size}/3755_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":263,"username":"1vanK","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/1vank/{size}/768_2.png"}}]},{"id":7347,"title":"How does Urho handle script objects each frame?","fancy_title":"How does Urho handle script objects each frame?","slug":"how-does-urho-handle-script-objects-each-frame","posts_count":3,"reply_count":1,"highest_post_number":3,"image_url":null,"created_at":"2022-11-08T02:33:56.461Z","last_posted_at":"2022-11-08T14:46:09.857Z","bumped":true,"bumped_at":"2022-11-08T14:46:09.857Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":64,"category_id":9,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":1292,"username":"evolgames","name":"evol","avatar_template":"/user_avatar/discourse.urho3d.io/evolgames/{size}/3169_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}}]},{"id":7212,"title":"Shadow Gap between Feet and Plane","fancy_title":"Shadow Gap between Feet and Plane","slug":"shadow-gap-between-feet-and-plane","posts_count":2,"reply_count":0,"highest_post_number":2,"image_url":"https://global.discourse-cdn.com/standard17/uploads/urho3d/optimized/2X/8/897538cff25de49fafa7aa77574f822e99576b67_2_1024x686.jpeg","created_at":"2022-03-07T00:04:17.351Z","last_posted_at":"2022-03-07T00:17:57.413Z","bumped":true,"bumped_at":"2022-03-07T00:17:57.413Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":2,"views":137,"category_id":10,"featured_link":null,"has_accepted_answer":true,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster, Accepted Answer","user":{"id":1334,"username":"najak3d","name":"Brian Knox","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/n/6a8cbe/{size}.png"}}]},{"id":7115,"title":"Is it possbile to use one billboard for a lens flare?","fancy_title":"Is it possbile to use one billboard for a lens flare?","slug":"is-it-possbile-to-use-one-billboard-for-a-lens-flare","posts_count":17,"reply_count":4,"highest_post_number":17,"image_url":null,"created_at":"2022-01-02T03:10:48.953Z","last_posted_at":"2022-01-03T21:37:51.953Z","bumped":true,"bumped_at":"2022-01-03T21:37:51.953Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":4,"views":275,"category_id":10,"featured_link":null,"has_accepted_answer":true,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":861,"username":"GodMan","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/g/e79b87/{size}.png"}},{"extras":null,"description":"Frequent Poster, Accepted Answer","user":{"id":192,"username":"Modanung","name":"魔大农 𝞍𝞎𝝳 現招蜍","avatar_template":"/user_avatar/discourse.urho3d.io/modanung/{size}/3290_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}}]}],"tags_descriptions":{},"id":5285,"title":"Support for ReturnValue in ScriptInstance::Execute","fancy_title":"Support for ReturnValue in ScriptInstance::Execute","posts_count":19,"created_at":"2019-07-07T05:49:32.821Z","views":640,"reply_count":7,"like_count":15,"last_posted_at":"2019-08-01T13:28:54.947Z","visible":true,"closed":false,"archived":false,"has_summary":false,"archetype":"regular","slug":"support-for-returnvalue-in-scriptinstance-execute","category_id":9,"word_count":3410,"deleted_at":null,"user_id":1098,"featured_link":null,"pinned_globally":false,"pinned_at":null,"pinned_until":null,"image_url":null,"slow_mode_seconds":0,"draft":null,"draft_key":"topic_5285","draft_sequence":null,"unpinned":null,"pinned":false,"current_post_number":1,"highest_post_number":19,"deleted_by":null,"actions_summary":[{"id":4,"count":0,"hidden":false,"can_act":false},{"id":8,"count":0,"hidden":false,"can_act":false},{"id":7,"count":0,"hidden":false,"can_act":false}],"chunk_size":20,"bookmarked":false,"bookmarks":[],"topic_timer":null,"message_bus_last_id":0,"participant_count":3,"show_read_indicator":false,"thumbnails":null,"slow_mode_enabled_until":null,"tags_disable_ads":false,"accepted_answer":{"post_number":16,"username":"Leith","excerpt":"Here is a proposed patch to allow AngelScript to return rubber values to C++ callers - changes appear not to break existing code … both functions and script class methods are supported - return values are anything we can shove into a variant, including arrays, and possibly, arrays of arrays, of any \u0026hellip;"},"details":{"can_edit":false,"notification_level":1,"participants":[{"id":1098,"username":"Leith","name":"Leith Ketchell","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","post_count":15,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":1},{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png","post_count":3,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2},{"id":627,"username":"George1","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/g/9e8a1a/{size}.png","post_count":1,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2}],"created_by":{"id":1098,"username":"Leith","name":"Leith Ketchell","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png"},"last_poster":{"id":1098,"username":"Leith","name":"Leith Ketchell","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png"},"links":[{"url":"https://www.dropbox.com/s/d48oorgsgz6okoz/AngelScript_FullRV.zip?dl=0","title":"Dropbox - AngelScript_FullRV.zip - Simplify your life","internal":false,"attachment":false,"reflection":false,"clicks":5,"user_id":1098,"domain":"www.dropbox.com","root_domain":"dropbox.com"}]}}