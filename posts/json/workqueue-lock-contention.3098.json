{"post_stream":{"posts":[{"id":17660,"name":"","username":"Enhex","avatar_template":"/user_avatar/discourse.urho3d.io/enhex/{size}/81_2.png","created_at":"2017-05-03T18:13:29.436Z","cooked":"\u003cp\u003eIt seems the WorkQueue implementation suffers from lock contention problem.\u003c/p\u003e\n\u003cp\u003eI’ve ran concurrency profiling in VS2017 on sample 18_CharacterDemo, and I’m getting ~400 lock contentions at any given moment (per frame?):\u003cbr\u003e\n\u003cimg src=\"//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/c4305312a434f59f521d8deee3fe8682e0c6041a.png\"\u003e\u003c/p\u003e\n\u003cp\u003eWhich mostly come from WorkQueue::ProcessItems():\u003cbr\u003e\n\u003cimg src=\"//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/bb9d196731a5149b0510de7ddbec92ef1e4894a0.png\"\u003e\u003c/p\u003e\n\u003cp\u003eProbably depends on the CPU, for some users this doesn’t have any noticeable effect, for others it causes small stuttering, and if they use -nothreads it significantly reduces the stuttering.\u003c/p\u003e\n\u003cp\u003eI’m not proficient with multithreaded programming, but maybe lock-free queue can be used here to solve this problem?\u003cbr\u003e\nThere’re libraries such as \u003ca href=\"http://www.boost.org/doc/libs/1_64_0/doc/html/lockfree.html\" rel=\"nofollow noopener\"\u003eBoost.Lockfree\u003c/a\u003e and \u003ca href=\"https://github.com/khizmax/libcds\" rel=\"nofollow noopener\"\u003elibcds\u003c/a\u003e that provide implementations.\u003c/p\u003e","post_number":1,"post_type":1,"updated_at":"2017-05-03T18:23:19.607Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":25,"reads":45,"readers_count":44,"score":134.0,"yours":false,"topic_id":3098,"topic_slug":"workqueue-lock-contention","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":3,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"https://github.com/khizmax/libcds","internal":false,"reflection":false,"title":"GitHub - khizmax/libcds: A C++ library of Concurrent Data Structures","clicks":3},{"url":"http://www.boost.org/doc/libs/1_64_0/doc/html/lockfree.html","internal":false,"reflection":false,"title":"Chapter 22. Boost.Lockfree - 1.64.0","clicks":0}],"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":184,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17661,"name":"Lasse Öörni","username":"cadaver","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png","created_at":"2017-05-03T18:21:04.707Z","cooked":"\u003cp\u003eIt could be looked into; from what I investigated the worst part is the possible latency when spinning up a worker thread, not necessarily lock contention itself. On the other hand, workers shouldn’t spin 100% of the CPU when they don’t have work to do.\u003c/p\u003e","post_number":2,"post_type":1,"updated_at":"2017-05-03T18:21:04.707Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":1,"reads":43,"readers_count":42,"score":13.6,"yours":false,"topic_id":3098,"topic_slug":"workqueue-lock-contention","display_username":"Lasse Öörni","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Urho3D Author","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":true,"staff":true,"user_id":3,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17681,"name":"","username":"sabotage3d","avatar_template":"/user_avatar/discourse.urho3d.io/sabotage3d/{size}/87_2.png","created_at":"2017-05-04T14:27:20.124Z","cooked":"\u003cp\u003eWhen C++11 is enabled maybe we can have something like this: \u003ca href=\"https://github.com/cameron314/concurrentqueue\" rel=\"nofollow noopener\"\u003ehttps://github.com/cameron314/concurrentqueue\u003c/a\u003e.\u003c/p\u003e","post_number":3,"post_type":1,"updated_at":"2017-05-04T14:27:20.124Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":4,"reads":38,"readers_count":37,"score":27.6,"yours":false,"topic_id":3098,"topic_slug":"workqueue-lock-contention","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"https://github.com/cameron314/concurrentqueue","internal":false,"reflection":false,"title":"GitHub - cameron314/concurrentqueue: A fast multi-producer, multi-consumer lock-free concurrent queue for C++11","clicks":14}],"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":151,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17683,"name":"Lasse Öörni","username":"cadaver","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png","created_at":"2017-05-04T16:39:49.462Z","cooked":"\u003cp\u003eForgot to say that some of the lock contention is intentional, because blocking the worker threads and preventing them spinning the CPU when they don’t have work is done with the same lock. Tried a signal back then (for waking them up) and it resulted in worse latency.\u003c/p\u003e\n\u003cp\u003eThis is an unorthodox design, so better solutions are gladly received. Possibly something like that once a worker thread wakes up for one frame, it doesn’t go to sleep, but spins for more tasks.\u003c/p\u003e\n\u003cp\u003eThe problem is that we’re not a 100% task-driven engine, but the main thread still orchestrates things heavily, and worker threads do only occasional work.\u003c/p\u003e","post_number":4,"post_type":1,"updated_at":"2017-05-04T16:39:49.462Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":37,"readers_count":36,"score":12.4,"yours":false,"topic_id":3098,"topic_slug":"workqueue-lock-contention","display_username":"Lasse Öörni","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Urho3D Author","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":true,"staff":true,"user_id":3,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17685,"name":"","username":"Victor","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/v/3e96dc/{size}.png","created_at":"2017-05-04T17:18:32.197Z","cooked":"\u003cp\u003eI think I ran into an issue where my WorkerThreads were running on the main thread, and for some reason I couldn’t push them off into their own thread. My guess is that my implementation was just incorrect, so I ended up making my own thread class that extended Urho3D::Thread, and I created a ThreadManager class.\u003c/p\u003e\n\u003cp\u003ePerhaps there could be an example at some point with the proper use of using the worker thread system. While the documentation seems pretty straight forward, I feel like I was still not grasping some of the concepts, and therefore my implementation was just wrong. Perhaps an example of creating a loading screen would be ideal (if any has some time). \u003cimg src=\"https://emoji.discourse-cdn.com/twitter/slight_smile.png?v=5\" title=\":slight_smile:\" class=\"emoji\" alt=\":slight_smile:\"\u003e\u003c/p\u003e","post_number":5,"post_type":1,"updated_at":"2017-05-04T17:18:32.197Z","reply_count":0,"reply_to_post_number":4,"quote_count":0,"incoming_link_count":0,"reads":39,"readers_count":38,"score":7.8,"yours":false,"topic_id":3098,"topic_slug":"workqueue-lock-contention","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"","reply_to_user":{"username":"cadaver","name":"Lasse Öörni","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":461,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17763,"name":"Pencheff","username":"Pencheff","avatar_template":"/user_avatar/discourse.urho3d.io/pencheff/{size}/259_2.png","created_at":"2017-05-11T07:35:58.086Z","cooked":"\u003cp\u003eHow about \u003ca href=\"http://en.cppreference.com/w/cpp/thread/condition_variable\" rel=\"nofollow noopener\"\u003econdition variables\u003c/a\u003e. Implementing a worker thread is straightforward, push some work into a queue and signal through a condition variable that one/many workers are waiting.\u003c/p\u003e","post_number":6,"post_type":1,"updated_at":"2017-05-11T07:37:06.617Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":32,"readers_count":31,"score":6.4,"yours":false,"topic_id":3098,"topic_slug":"workqueue-lock-contention","display_username":"Pencheff","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"http://en.cppreference.com/w/cpp/thread/condition_variable","internal":false,"reflection":false,"title":"std::condition_variable - cppreference.com","clicks":8}],"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":691,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":17791,"name":"Pencheff","username":"Pencheff","avatar_template":"/user_avatar/discourse.urho3d.io/pencheff/{size}/259_2.png","created_at":"2017-05-13T10:49:22.293Z","cooked":"\u003cp\u003eIndeed, I just did profiling in my project - the worker threads are spending more time in mutex locking than 3 of my worker threads for decoding/rendering full HD mpeg4 video. I’d be glad to PR once I get some spare time.\u003c/p\u003e","post_number":7,"post_type":1,"updated_at":"2017-05-13T10:49:22.293Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":1,"reads":23,"readers_count":22,"score":9.6,"yours":false,"topic_id":3098,"topic_slug":"workqueue-lock-contention","display_username":"Pencheff","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":691,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false}],"stream":[17660,17661,17681,17683,17685,17763,17791]},"timeline_lookup":[[1,2029],[5,2028],[6,2022],[7,2020]],"suggested_topics":[{"id":7062,"title":"Is WebGL2.0 \u0026 GLES3.0 being supported in the near future?","fancy_title":"Is WebGL2.0 \u0026amp; GLES3.0 being supported in the near future?","slug":"is-webgl2-0-gles3-0-being-supported-in-the-near-future","posts_count":2,"reply_count":0,"highest_post_number":2,"image_url":null,"created_at":"2021-11-23T09:04:28.802Z","last_posted_at":"2021-11-23T21:44:08.088Z","bumped":true,"bumped_at":"2021-11-23T21:44:08.088Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":1,"views":199,"category_id":16,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":null,"description":"Original Poster","user":{"id":1490,"username":"Sunc","name":"DoubleSuper","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/df788c/{size}.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":631,"username":"JTippetts1","name":"J Tippetts","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts1/{size}/96_2.png"}}]},{"id":7196,"title":"Windows Urho3D build with -DURHO3D_OPENGL=1 using rake","fancy_title":"Windows Urho3D build with -DURHO3D_OPENGL=1 using rake","slug":"windows-urho3d-build-with-durho3d-opengl-1-using-rake","posts_count":18,"reply_count":9,"highest_post_number":19,"image_url":null,"created_at":"2022-02-20T12:49:25.777Z","last_posted_at":"2022-02-24T18:24:11.679Z","bumped":true,"bumped_at":"2022-02-24T18:24:11.679Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":3,"views":254,"category_id":16,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":null,"description":"Original Poster","user":{"id":421,"username":"Lunarovich","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/lunarovich/{size}/2097_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":263,"username":"1vanK","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/1vank/{size}/768_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":631,"username":"JTippetts1","name":"J Tippetts","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts1/{size}/96_2.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":4,"username":"weitjong","name":"Yao Wei Tjong","avatar_template":"/user_avatar/discourse.urho3d.io/weitjong/{size}/4_2.png"}}]},{"id":7095,"title":"Texture2D from imported GPU memory (interop)","fancy_title":"Texture2D from imported GPU memory (interop)","slug":"texture2d-from-imported-gpu-memory-interop","posts_count":6,"reply_count":2,"highest_post_number":6,"image_url":null,"created_at":"2021-12-09T10:52:31.426Z","last_posted_at":"2021-12-13T15:40:35.300Z","bumped":true,"bumped_at":"2021-12-13T15:40:35.300Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":1,"views":316,"category_id":16,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":1496,"username":"ange","name":null,"avatar_template":"https://avatars.discourse-cdn.com/v4/letter/a/76d3ee/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":484,"username":"Eugene","name":"Eugene Kozlov","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}}]},{"id":7136,"title":"Open-source ocean shader system","fancy_title":"Open-source ocean shader system","slug":"open-source-ocean-shader-system","posts_count":1,"reply_count":0,"highest_post_number":1,"image_url":null,"created_at":"2022-01-19T23:11:15.784Z","last_posted_at":"2022-01-19T23:11:15.858Z","bumped":true,"bumped_at":"2022-01-19T23:11:15.858Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":1,"views":177,"category_id":16,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster","user":{"id":1304,"username":"lebrewer","name":"lebrewer","avatar_template":"/user_avatar/discourse.urho3d.io/lebrewer/{size}/2811_2.png"}}]},{"id":7211,"title":"Particle is low","fancy_title":"Particle is low","slug":"particle-is-low","posts_count":2,"reply_count":0,"highest_post_number":2,"image_url":null,"created_at":"2022-03-03T13:52:14.991Z","last_posted_at":"2022-04-20T05:18:36.122Z","bumped":true,"bumped_at":"2022-04-20T05:18:36.122Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":232,"category_id":16,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":null,"description":"Original Poster","user":{"id":1503,"username":"tianlv777","name":"zerrrrr","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/t/a4c791/{size}.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":1491,"username":"xlat","name":"Alex Kuch","avatar_template":"/user_avatar/discourse.urho3d.io/xlat/{size}/3620_2.png"}}]}],"tags_descriptions":{},"id":3098,"title":"WorkQueue Lock Contention","fancy_title":"WorkQueue Lock Contention","posts_count":7,"created_at":"2017-05-03T18:13:29.370Z","views":739,"reply_count":1,"like_count":0,"last_posted_at":"2017-05-13T10:49:22.293Z","visible":true,"closed":false,"archived":false,"has_summary":false,"archetype":"regular","slug":"workqueue-lock-contention","category_id":16,"word_count":507,"deleted_at":null,"user_id":184,"featured_link":null,"pinned_globally":false,"pinned_at":null,"pinned_until":null,"image_url":"https://global.discourse-cdn.com/standard17/uploads/urho3d/optimized/1X/c4305312a434f59f521d8deee3fe8682e0c6041a_2_1024x685.png","slow_mode_seconds":0,"draft":null,"draft_key":"topic_3098","draft_sequence":null,"unpinned":null,"pinned":false,"current_post_number":1,"highest_post_number":7,"deleted_by":null,"actions_summary":[{"id":4,"count":0,"hidden":false,"can_act":false},{"id":8,"count":0,"hidden":false,"can_act":false},{"id":7,"count":0,"hidden":false,"can_act":false}],"chunk_size":20,"bookmarked":false,"bookmarks":[],"topic_timer":null,"message_bus_last_id":0,"participant_count":5,"show_read_indicator":false,"thumbnails":[{"max_width":null,"max_height":null,"width":1082,"height":724,"url":"https://global.discourse-cdn.com/standard17/uploads/urho3d/original/1X/c4305312a434f59f521d8deee3fe8682e0c6041a.png"},{"max_width":1024,"max_height":1024,"width":1024,"height":685,"url":"https://global.discourse-cdn.com/standard17/uploads/urho3d/optimized/1X/c4305312a434f59f521d8deee3fe8682e0c6041a_2_1024x685.png"}],"slow_mode_enabled_until":null,"tags_disable_ads":false,"details":{"can_edit":false,"notification_level":1,"participants":[{"id":3,"username":"cadaver","name":"Lasse Öörni","avatar_template":"/user_avatar/discourse.urho3d.io/cadaver/{size}/3_2.png","post_count":2,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"admin":true,"trust_level":2},{"id":691,"username":"Pencheff","name":"Pencheff","avatar_template":"/user_avatar/discourse.urho3d.io/pencheff/{size}/259_2.png","post_count":2,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2},{"id":151,"username":"sabotage3d","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/sabotage3d/{size}/87_2.png","post_count":1,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2},{"id":184,"username":"Enhex","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/enhex/{size}/81_2.png","post_count":1,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2},{"id":461,"username":"Victor","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/v/3e96dc/{size}.png","post_count":1,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2}],"created_by":{"id":184,"username":"Enhex","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/enhex/{size}/81_2.png"},"last_poster":{"id":691,"username":"Pencheff","name":"Pencheff","avatar_template":"/user_avatar/discourse.urho3d.io/pencheff/{size}/259_2.png"},"links":[{"url":"https://github.com/cameron314/concurrentqueue","title":"GitHub - cameron314/concurrentqueue: A fast multi-producer, multi-consumer lock-free concurrent queue for C++11","internal":false,"attachment":false,"reflection":false,"clicks":14,"user_id":151,"domain":"github.com","root_domain":"github.com"},{"url":"http://en.cppreference.com/w/cpp/thread/condition_variable","title":"std::condition_variable - cppreference.com","internal":false,"attachment":false,"reflection":false,"clicks":8,"user_id":691,"domain":"en.cppreference.com","root_domain":"cppreference.com"},{"url":"https://github.com/khizmax/libcds","title":"GitHub - khizmax/libcds: A C++ library of Concurrent Data Structures","internal":false,"attachment":false,"reflection":false,"clicks":3,"user_id":184,"domain":"github.com","root_domain":"github.com"}]}}