{"post_stream":{"posts":[{"id":42056,"name":"","username":"DinS","avatar_template":"/user_avatar/discourse.urho3d.io/dins/{size}/1573_2.png","created_at":"2021-03-03T03:24:36.974Z","cooked":"\u003cp\u003eWhile I am working on a project with Urho3D, I have found there’s no built-in way to play video, so I write my own. Since this is a general problem, I’d like to share my work with the community.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eOverview\u003cbr\u003e\nIn the zip file, which can be found at the end of this post, there’re 5 files.\u003cbr\u003e\nThe MpgVideo.h/cpp defines a new type of Resource. It uses \u003ca href=\"https://github.com/phoboslab/pl_mpeg\" rel=\"noopener nofollow ugc\"\u003eplmpeg\u003c/a\u003e (MIT license C library) to decode the mpg.\u003cbr\u003e\nThe VideoPlayer.h/cpp defines a new type of component. It uses MpgVideo to play the video.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThe problem with video playback is that decoding takes a lot of time and memory space.\u003cbr\u003e\nFor a 1280 X 900 mpg video that lasts 18 seconds, which is pretty common, it will take several seconds to fully decode, and the fully decoded video frames will take 1280x900x3x30x18 = 1780MB! \u003cimg src=\"https://emoji.discourse-cdn.com/twitter/scream.png?v=9\" title=\":scream:\" class=\"emoji\" alt=\":scream:\"\u003e\u003cbr\u003e\nSo here comes the idea of streaming. Only decode when we need a new frame, aka decode as you watch(`). Throw out played frames to keep memory small, aka discard as you watch(``). Streaming makes the code neat and keeps performance high.\u003c/p\u003e\n\u003cp\u003e` This is true ONLY IF you have a powerful CPU. the CPU needs to decode video frame to raw pixel, format it to Urho3D::Sprite2D, and show it on screen within one Urho3D::Update. The good news is that you can expect it to work for modern CPU.\u003cbr\u003e\n`` The code achieves this by not keeping the Sprite2D in resource cache. BUT after rendering on screen, the render will hold a SharedPtr to the resource, so it can’t be released automatically. To solve this check this \u003ca href=\"https://discourse.urho3d.io/t/dynamic-loaded-sprite-leaks-memory/6149/3\"\u003epost\u003c/a\u003e. Also see discussion below.\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eUsage\u003cbr\u003e\n(1) copy the files under the same folder and add to your project. If you want to place them separately, change the \u003cspan class=\"hashtag\"\u003e#include\u003c/span\u003e accordingly.\u003cbr\u003e\n(2) register the types before use, for example in the constructor of your application, write\u003cbr\u003e\nMpgVideo::RegisterObject(context);\u003cbr\u003e\nVideoPlayer::RegisterObject(context);\u003cbr\u003e\n(3) code as if they are Urho3D built-in types. For example:\u003cbr\u003e\n//Setup 2D Scene…\u003cbr\u003e\nauto pPic = _gameScene-\u0026gt;CreateChild(“test_mpg”);\u003cbr\u003e\npPic-\u0026gt;SetPosition2D(0, 0);\u003cbr\u003e\nauto pCom = pPic-\u0026gt;CreateComponent\u0026lt; VideoPlayer \u0026gt;();\u003cbr\u003e\nauto pMpg = GetSubsystem\u0026lt; ResourceCache \u0026gt;()-\u0026gt;GetResource\u0026lt; MpgVideo \u0026gt;(“Data/video/test1.mpg”);\u003cbr\u003e\npCom-\u0026gt;SetMpg(pMpg, 1.0f);\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eCheck this demon video.\u003c/p\u003e          \u003cdiv class=\"onebox video-onebox\"\u003e\n            \u003cvideo width=\"100%\" height=\"100%\" controls=\"\"\u003e\n              \u003csource src=\"https://dins.site/wp-content/uploads/2021/03/DemonVideo.mp4\"\u003e\n              \u003ca href=\"https://dins.site/wp-content/uploads/2021/03/DemonVideo.mp4\" rel=\"noopener nofollow ugc\"\u003ehttps://dins.site/wp-content/uploads/2021/03/DemonVideo.mp4\u003c/a\u003e\n            \u003c/source\u003e\u003c/video\u003e\n          \u003c/div\u003e\n\u003cp\u003e\nOn the left side, you can see that before the video, CPU is about 30%, memory is about 40MB. While playing video CPU goes up to 80%, memory stays at 60MB. Using the code directly won’t get you there. The memory will not be freed. See discussion below.\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eDiscussion\u003cbr\u003e\nTo completely remove a rendered resource from memory, I changed the Render2D class. As pointed out in this \u003ca href=\"https://discourse.urho3d.io/t/dynamic-loaded-sprite-leaks-memory/6149/3\"\u003epost\u003c/a\u003e,  I added an UncacheTexture method, and remove cachedMaterials_ accordingly. But from my experience I found this is not enough. Also need to call viewBatchInfos_.Clear() to completely wipe out SharePtr\u0026lt; Material \u0026gt;.\u003cbr\u003e\nBut I’m not sure if this is the proper way to do this. I hope someone can answer my doubt. That is how to completely remove a rendered resource from memory?\u003cbr\u003e\nSince this modification is not standard Urho3D, I commented out the codes in VideoPlayer. And that’s the reason you will not see memory released if you use the code directly.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e4.Notice\u003cbr\u003e\n(1) if you want to predecode the video and save in cache, you need to come up with your own way.\u003cbr\u003e\n(2) the mpg file needs to be MPEG1 video and MP2 audio. You can use ffmpeg to convert file format. check pl_mpeg site for detail.\u003cbr\u003e\n(3) MSVC user: since it uses a C library, you may need to change IDE grammar check from C++ to C.\u003cbr\u003e\n(4) MSVC user: there’re a lot of comments in CHINESE, which is my mother tongue. They are mostly about background knowledge on the media format, rationale and C library usage. If you just want to play an mpg, don’t bother. But you need to change the encoding from UTF-8 to UTF-8 BOM, or else MSVC will output strange errors. Personally I think it’s a flaw in the compiler. Apple Clang and g++ don’t have this issue. Another way is to just remove all comments.\u003c/p\u003e\n\u003cp\u003e5.Download\u003cbr\u003e\nThe forum doesn’t allow zip file uploading, so I have put the file on my website for your access.\u003cbr\u003e\n\u003ca href=\"https://dins.site/wp-content/uploads/2021/03/mpg-addon.zip\" class=\"onebox\" target=\"_blank\" rel=\"noopener nofollow ugc\"\u003ehttps://dins.site/wp-content/uploads/2021/03/mpg-addon.zip\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe codes are released under MIT license.\u003cbr\u003e\nHope this can help some people in the future.\u003cbr\u003e\nCheers!\u003c/p\u003e","post_number":1,"post_type":1,"updated_at":"2021-03-03T03:37:14.565Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":37,"reads":35,"readers_count":34,"score":297.0,"yours":false,"topic_id":6745,"topic_slug":"a-lightweight-streaming-mpg-video-player-for-you-cheers","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":3,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"https://dins.site/wp-content/uploads/2021/03/mpg-addon.zip","internal":false,"reflection":false,"clicks":5},{"url":"https://github.com/phoboslab/pl_mpeg","internal":false,"reflection":false,"title":"GitHub - phoboslab/pl_mpeg: Single file C library for decoding MPEG1 Video and MP2 Audio","clicks":3},{"url":"https://discourse.urho3d.io/t/dynamic-loaded-sprite-leaks-memory/6149/3","internal":true,"reflection":false,"title":"Dynamic loaded sprite leaks memory","clicks":1},{"url":"https://dins.site/wp-content/uploads/2021/03/DemonVideo.mp4","internal":false,"reflection":false,"clicks":0}],"read":true,"user_title":null,"bookmarked":false,"actions_summary":[{"id":2,"count":5}],"moderator":false,"admin":false,"staff":false,"user_id":1018,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":42057,"name":null,"username":"vmost","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/v/5f9b8f/{size}.png","created_at":"2021-03-03T04:06:07.093Z","cooked":"\u003cp\u003eCould you get new frames in a separate thread? Then sync the video frame rate with game frame rate by matching frame expected-time with real-time. Seems like a fun project.\u003c/p\u003e","post_number":2,"post_type":1,"updated_at":"2021-03-03T04:06:07.093Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":33,"readers_count":32,"score":11.6,"yours":false,"topic_id":6745,"topic_slug":"a-lightweight-streaming-mpg-video-player-for-you-cheers","display_username":null,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1363,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":42058,"name":"SirNate0","username":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png","created_at":"2021-03-03T05:20:37.639Z","cooked":"\u003cp\u003eThanks for the contribution!\u003cbr\u003e\nAlso, I thought I’d point out that there is a way to play Theora videos with code here, though it certainly isn’t part of the engine itself.\u003c/p\u003e\n\u003caside class=\"quote\" data-post=\"14\" data-topic=\"2144\"\u003e\n  \u003cdiv class=\"title\"\u003e\n    \u003cdiv class=\"quote-controls\"\u003e\u003c/div\u003e\n    \u003cimg alt=\"\" width=\"20\" height=\"20\" src=\"https://avatars.discourse-cdn.com/v4/letter/l/8491ac/40.png\" class=\"avatar\"\u003e\n    \u003ca href=\"https://discourse.urho3d.io/t/theora-video-playback/2144/14\"\u003eTheora video playback\u003c/a\u003e \u003ca class=\"badge-wrapper  bullet\" href=\"/c/showcase/code-exchange/13\"\u003e\u003cspan class=\"badge-category-parent-bg\" style=\"background-color: #F1592A;\"\u003e\u003c/span\u003e\u003cspan class=\"badge-category-bg\" style=\"background-color: #231F20;\"\u003e\u003c/span\u003e\u003cspan style=\"\" data-drop-close=\"true\" class=\"badge-category clear-badge\" title=\"Share your helpful Urho3D code snippets, samples and tutorials here.\"\u003eCode Exchange\u003c/span\u003e\u003c/a\u003e\n  \u003c/div\u003e\n  \u003cblockquote\u003e\n    Audio should be in sync now, \u003ca href=\"https://github.com/Lumak/Urho3D-Theora\"\u003ehttps://github.com/Lumak/Urho3D-Theora\u003c/a\u003e\n  \u003c/blockquote\u003e\n\u003c/aside\u003e\n","post_number":3,"post_type":1,"updated_at":"2021-03-03T05:20:37.639Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":33,"readers_count":32,"score":6.6,"yours":false,"topic_id":6745,"topic_slug":"a-lightweight-streaming-mpg-video-player-for-you-cheers","display_username":"SirNate0","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"https://discourse.urho3d.io/t/theora-video-playback/2144/14","internal":true,"reflection":false,"title":"Theora video playback","clicks":0}],"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":628,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":42063,"name":"","username":"DinS","avatar_template":"/user_avatar/discourse.urho3d.io/dins/{size}/1573_2.png","created_at":"2021-03-03T14:42:45.277Z","cooked":"\u003cp\u003eThe code here is a lightweight version. In fact what I am using in my project is a smart video player. That is it can determine how many frames to decode in advance according to CPU powerful, decode in a different thread and sync with the engine. But that uses std::thread and std::chrono. So I’d like to keep things simple here.\u003c/p\u003e","post_number":4,"post_type":1,"updated_at":"2021-03-03T14:42:45.277Z","reply_count":0,"reply_to_post_number":2,"quote_count":0,"incoming_link_count":0,"reads":30,"readers_count":29,"score":6.0,"yours":false,"topic_id":6745,"topic_slug":"a-lightweight-streaming-mpg-video-player-for-you-cheers","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"reply_to_user":{"username":"vmost","name":null,"avatar_template":"https://avatars.discourse-cdn.com/v4/letter/v/5f9b8f/{size}.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1018,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false}],"stream":[42056,42057,42058,42063]},"timeline_lookup":[[1,630]],"suggested_topics":[{"id":7120,"title":"Log Error Once Macro","fancy_title":"Log Error Once Macro","slug":"log-error-once-macro","posts_count":1,"reply_count":0,"highest_post_number":1,"image_url":null,"created_at":"2022-01-04T02:24:37.857Z","last_posted_at":"2022-01-04T02:24:37.925Z","bumped":true,"bumped_at":"2022-01-04T02:24:37.925Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":3,"views":143,"category_id":13,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}}]},{"id":7103,"title":":test_tube: DebugRenderer as GUI","fancy_title":":test_tube: DebugRenderer as GUI","slug":"debugrenderer-as-gui","posts_count":4,"reply_count":1,"highest_post_number":4,"image_url":null,"created_at":"2021-12-17T02:25:06.606Z","last_posted_at":"2021-12-18T01:09:27.738Z","bumped":true,"bumped_at":"2021-12-18T01:09:27.738Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"unicode_title":"🧪 DebugRenderer as GUI","tags_descriptions":{},"like_count":4,"views":267,"category_id":13,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":192,"username":"Modanung","name":"魔大农 𝞍𝞎𝝳 現招蜍","avatar_template":"/user_avatar/discourse.urho3d.io/modanung/{size}/3290_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":861,"username":"GodMan","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/g/e79b87/{size}.png"}}]},{"id":7110,"title":"Resource fetch define","fancy_title":"Resource fetch define","slug":"resource-fetch-define","posts_count":2,"reply_count":0,"highest_post_number":2,"image_url":null,"created_at":"2021-12-27T12:28:55.126Z","last_posted_at":"2021-12-27T17:00:37.699Z","bumped":true,"bumped_at":"2021-12-27T17:00:37.699Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":7,"views":184,"category_id":13,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":null,"description":"Original Poster","user":{"id":192,"username":"Modanung","name":"魔大农 𝞍𝞎𝝳 現招蜍","avatar_template":"/user_avatar/discourse.urho3d.io/modanung/{size}/3290_2.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":1304,"username":"lebrewer","name":"lebrewer","avatar_template":"/user_avatar/discourse.urho3d.io/lebrewer/{size}/2811_2.png"}}]},{"id":7099,"title":":fallen_leaf: Polynomials \u0026 Harmonics","fancy_title":":fallen_leaf: Polynomials \u0026amp; Harmonics","slug":"polynomials-harmonics","posts_count":6,"reply_count":0,"highest_post_number":7,"image_url":null,"created_at":"2021-12-13T05:06:04.641Z","last_posted_at":"2021-12-27T23:27:39.489Z","bumped":true,"bumped_at":"2021-12-27T23:27:39.489Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"unicode_title":"🍂 Polynomials \u0026 Harmonics","tags_descriptions":{},"like_count":6,"views":392,"category_id":13,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster","user":{"id":192,"username":"Modanung","name":"魔大农 𝞍𝞎𝝳 現招蜍","avatar_template":"/user_avatar/discourse.urho3d.io/modanung/{size}/3290_2.png"}}]},{"id":7284,"title":"[Solved] Moving a Navigation Mesh","fancy_title":"[Solved] Moving a Navigation Mesh","slug":"solved-moving-a-navigation-mesh","posts_count":4,"reply_count":1,"highest_post_number":4,"image_url":null,"created_at":"2022-06-20T20:10:14.786Z","last_posted_at":"2022-06-21T21:25:22.088Z","bumped":true,"bumped_at":"2022-06-21T21:25:22.088Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":138,"category_id":10,"featured_link":null,"has_accepted_answer":true,"posters":[{"extras":null,"description":"Original Poster, Accepted Answer","user":{"id":1228,"username":"PsychoCircuitry","name":null,"avatar_template":"https://avatars.discourse-cdn.com/v4/letter/p/a9a28c/{size}.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":1358,"username":"JSandusky","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/jsandusky/{size}/3220_2.png"}}]}],"tags_descriptions":{},"id":6745,"title":"A Lightweight Streaming Mpg Video Player for You, Cheers!","fancy_title":"A Lightweight Streaming Mpg Video Player for You, Cheers!","posts_count":4,"created_at":"2021-03-03T03:24:36.901Z","views":469,"reply_count":1,"like_count":5,"last_posted_at":"2021-03-03T14:42:45.277Z","visible":true,"closed":false,"archived":false,"has_summary":false,"archetype":"regular","slug":"a-lightweight-streaming-mpg-video-player-for-you-cheers","category_id":13,"word_count":931,"deleted_at":null,"user_id":1018,"featured_link":null,"pinned_globally":false,"pinned_at":null,"pinned_until":null,"image_url":null,"slow_mode_seconds":0,"draft":null,"draft_key":"topic_6745","draft_sequence":null,"unpinned":null,"pinned":false,"current_post_number":1,"highest_post_number":4,"deleted_by":null,"actions_summary":[{"id":4,"count":0,"hidden":false,"can_act":false},{"id":8,"count":0,"hidden":false,"can_act":false},{"id":7,"count":0,"hidden":false,"can_act":false}],"chunk_size":20,"bookmarked":false,"bookmarks":[],"topic_timer":null,"message_bus_last_id":0,"participant_count":3,"show_read_indicator":false,"thumbnails":null,"slow_mode_enabled_until":null,"tags_disable_ads":false,"details":{"can_edit":false,"notification_level":1,"participants":[{"id":1018,"username":"DinS","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/dins/{size}/1573_2.png","post_count":2,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":1},{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png","post_count":1,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2},{"id":1363,"username":"vmost","name":null,"avatar_template":"https://avatars.discourse-cdn.com/v4/letter/v/5f9b8f/{size}.png","post_count":1,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2}],"created_by":{"id":1018,"username":"DinS","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/dins/{size}/1573_2.png"},"last_poster":{"id":1018,"username":"DinS","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/dins/{size}/1573_2.png"},"links":[{"url":"https://dins.site/wp-content/uploads/2021/03/mpg-addon.zip","title":null,"internal":false,"attachment":false,"reflection":false,"clicks":5,"user_id":1018,"domain":"dins.site","root_domain":"dins.site"},{"url":"https://github.com/phoboslab/pl_mpeg","title":"GitHub - phoboslab/pl_mpeg: Single file C library for decoding MPEG1 Video and MP2 Audio","internal":false,"attachment":false,"reflection":false,"clicks":3,"user_id":1018,"domain":"github.com","root_domain":"github.com"},{"url":"https://discourse.urho3d.io/t/dynamic-loaded-sprite-leaks-memory/6149/3","title":"Dynamic loaded sprite leaks memory","internal":true,"attachment":false,"reflection":false,"clicks":1,"user_id":1018,"domain":"discourse.urho3d.io","root_domain":"urho3d.io"}]}}